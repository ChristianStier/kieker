<?xml version="1.0" encoding="UTF-8"?>
<project name="Kicker (init and clean)" basedir=".." xmlns:artifact="antlib:org.apache.maven.artifact.ant">

	<property file="build-config/build.properties" />
	
	<target name="-init-version" description="Initializes variables based on the Kicker version number">
		<tstamp />
		<property name="kicker.name" value="Kicker Framework" />
		<property name="kicker.version" value="1.10-SNAPSHOT" />
		<property name="year" value="2014" />
		<property name="copyright" value="Kicker Project" />

		<property name="dist.kicker.main.sources.jar" value="${kicker.main.packagenamebase}-${kicker.version}-${kicker-src.suffix}.jar" />
		<property name="dist.kicker.main.sources.aspectj.jar" value="${kicker.main.packagenamebase}-${kicker.version}_aspectj-${kicker-src.suffix}.jar" />
		<property name="dist.kicker.main.sources.emf.jar" value="${kicker.main.packagenamebase}-${kicker.version}_emf-${kicker-src.suffix}.jar" />

		<property name="dist.kicker.main.javadoc.jar" value="${kicker.main.packagenamebase}-${kicker.version}-${kicker-api.suffix}.jar" />
		<property name="dist.kicker.main.javadoc.aspectj.jar" value="${kicker.main.packagenamebase}-${kicker.version}_aspectj-${kicker-api.suffix}.jar" />
		<property name="dist.kicker.main.javadoc.emf.jar" value="${kicker.main.packagenamebase}-${kicker.version}_emf-${kicker-api.suffix}.jar" />

		<property name="dist.kicker.main.pom" value="${kicker.main.packagenamebase}-${kicker.version}.pom" />

		<property name="dist.kicker.main.jar" value="${kicker.main.packagenamebase}-${kicker.version}.jar" />
		<property name="dist.kicker.main.aspectj.jar" value="${kicker.main.packagenamebase}-${kicker.version}_aspectj.jar" />
		<property name="dist.kicker.main.aspectj.jar.latex" value="${kicker.main.packagenamebase}-${kicker.version}\\\\\\_aspectj.jar" />
		<property name="dist.kicker.main.emf.jar" value="${kicker.main.packagenamebase}-${kicker.version}_emf.jar" />
		<property name="dist.kicker.main.emf.jar.latex" value="${kicker.main.packagenamebase}-${kicker.version}\\\\\\_emf.jar" />

		<property name="kicker.dist.name" value="${kicker.packagenamebase}-${kicker.version}" />
		<property name="dist.kicker.srcBaseName" value="${kicker.dist.name}_${kicker-src.suffix}" />
		<property name="dist.kicker.binBaseName" value="${kicker.dist.name}_${kicker-bin.suffix}" />
		<property name="dist.kicker.apiBaseName" value="${kicker.dist.name}_${kicker-api.suffix}" />
		<property name="dist.kicker.userguide.pdf" value="${kicker.dist.name}_${kicker-userguide.suffix}.pdf" />
	</target>

	<target name="-update-version" unless="version.noupdate" depends="-init-version" description="Updates the version number contained in the Kicker sources">
		<replaceregexp file="${src.kicker.common.dir}/kicker/common/util/Version.java" match="VERSION = &quot;.*?&quot;" replace="VERSION = &quot;${kicker.version}&quot;" />
		<replaceregexp file="bin/dev/check-release-archives.sh" match="KIEKER_VERSION=&quot;.*?&quot;" replace="KIEKER_VERSION=&quot;${kicker.version}&quot;" />
		<!-- Not sure if String valid today, but replacing it #1199: -->
		<replaceregexp file="test/tools/kicker/test/tools/manual/TestTCPReader.java" match="lib/kicker-.*_aspectj.jar" replace="lib/kicker-${kicker.version}_aspectj.jar" />

		<!-- Update the AspectJ version in various files -->
		<replaceregexp byline="true" flags="g">
			<regexp pattern="(aspectj.*)-.*.jar"/>
			<substitution expression="\1-${lib.aspectj.version}.jar"/>
			<fileset dir=".">
				<include name="${src.userguide.dir}/Macros.tex"/>
				<include name="${src.userguide.example.aspectj.dir}/BookstoreStarter.launch"/>
				<include name=".classpath"/>
			</fileset>
		</replaceregexp>
	</target>

	<target name="-init" depends="clean,-update-version,-init-compile-classpaths" description="Initializes variables and creates directories">
		<!-- Register special aspectj commands in ant - allow ant to use special AspectJ commands: -->
		<path id="aspectjtools-jar">
			<fileset dir="${lib.dir}">
				<include name="aspectjtools-*.jar" />
			</fileset>
		</path>
		<taskdef resource="org/aspectj/tools/ant/taskdefs/aspectjTaskdefs.properties" classpathref="aspectjtools-jar" />
		<mkdir dir="${build.dir}" />
		<mkdir dir="${dist.dir}" />
		<mkdir dir="${release.dir}" />
		<mkdir dir="${maven.dir}" />
		<mkdir dir="${build.tests.dir}" />
		<mkdir dir="${tmp.dir}" />
	</target>

	<!-- Compile classpaths used for javac and javadoc -->
	<target name="-init-compile-classpaths" description="Initializes the classpath variables for the compile and Javadoc targets">
		<path id="kicker.common-compile-classpath">
			<fileset dir="${lib.dir}">
				<include name="commons-logging-*.jar" />
				<include name="slf4j-api-*.jar" />
			</fileset>
		</path>

		<path id="kicker.monitoring-compile-classpath">
			<fileset dir="${lib.dir}">
				<!--<include name="aspectjrt-*.jar" />-->
				<include name="javax.jms-*.jar" />
				<include name="disl-*/disl-server.jar" />
				<include name="framework-libs/javax.servlet-*.jar" />
				<include name="framework-libs/cxf/cxf-*.jar" />
				<include name="framework-libs/spring/aopalliance-*.jar" />
				<include name="framework-libs/spring/spring-context-*.jar" />
				<include name="framework-libs/spring/spring-web*.jar" />
			</fileset>
			<fileset dir="${lib.sigar.dir}">
				<include name="sigar-*.jar" />
			</fileset>
			<pathelement location="${build.kicker.common.dir}/" />
		</path>

		<path id="kicker.monitoring-ajc-compile-classpath">
			<fileset dir="${lib.dir}">
				<include name="aspectjweaver-*.jar" />
				<include name="aspectjrt-*.jar" />
				<include name="framework-libs/javax.servlet-*.jar" />
			</fileset>
			<pathelement location="${build.kicker.common.dir}/" />
			<pathelement location="${build.kicker.monitoring.dir}" />
		</path>

		<path id="kicker.analysis-compile-classpath">
			<fileset dir="${lib.dir}">
				<include name="javax.jms-*.jar" />
				<include name="org.eclipse.emf.*.jar" />
			</fileset>
			<pathelement location="${build.kicker.common.dir}/" />
			<pathelement location="${build.kicker.analysis.model.dir}/" />
		</path>

		<path id="kicker.tools-compile-classpath">
			<fileset dir="${lib.dir}">
				<include name="commons-cli-*.jar" />
				<include name="jgraphx-*.jar" />
				<include name="org.eclipse.emf.*.jar" />
				<!-- Bridge begin -->
				<include name="activemq-*.jar" />
				<include name="kahadb-5.7.0.jar"/>
				<include name="javax.jms-*.jar" />
				<include name="reflections-*.jar"/>
				<include name="geronimo-j2ee-management_1.1_spec-*.jar"/>
				<!-- Bridge end -->
				<!-- OPAD begin -->
				 <!--<include name="mongo-*.jar"/>-->
				<include name="commons-math-*.jar"/>
				<include name="commons-lang-*.jar"/>
				 <!--<include name="REngine.jar"/>-->
				 <!--<include name="Rserve.jar"/>-->
 	 		 	 <!--<include name="Rsession.jar"/>-->
				<!-- OPAD end -->
			</fileset>
			<pathelement location="${build.kicker.common.dir}/" />
			<pathelement location="${build.kicker.monitoring.dir}/" />
			<pathelement location="${build.kicker.analysis.dir}/" />
			<pathelement location="${build.kicker.analysis.model.dir}/" />
		</path>

		<path id="javaee.demo-compile-classpath">
			<fileset dir="${example.javaee.demo.lib.dir}">
				<include name="primefaces-*.jar" />
				<include name="jsf-api-*.jar" />
			</fileset>
			<fileset dir="${example.javaee.jetty.lib.dir}/annotations/">
				<include name="javax.annotation-*.jar" />
			</fileset>
			<fileset dir="${dist.dir}">
				<include name="${dist.kicker.main.jar}" />
			</fileset>
		</path>
	</target>

	<target name="clean-userguide-examples" description="Removes artifacts from previous builds and manually changed configuration files">
		<ant antfile="build.xml" dir="${src.userguide.example.bookstore.dir}" target="clean" />
		<ant antfile="build.xml" dir="${src.userguide.example.manual.dir}" target="clean" />
		<ant antfile="build.xml" dir="${src.userguide.example.extended.dir}" target="clean" />
		<ant antfile="build.xml" dir="${src.userguide.example.aspectj.dir}" target="clean" />
		<ant antfile="build.xml" dir="${src.userguide.example.jms.dir}" target="clean" />
		<ant antfile="build.xml" dir="${src.userguide.example.sigar.dir}" target="clean" />
		<delete>
			<fileset dir="${examples.dir}" includes="**/.classpath-binrelease.generated" />
		</delete>
		<!-- make sure a current version is included -->
		<copy file="${kicker.monitoring.default.properties}" tofile="${src.userguide.example.aspectj.dir}/META-INF/kicker.monitoring.properties" />
	</target>

	<target name="-prepate-userguide-examples-binary-release" depends="-init-version" description="Removes artifacts from previous builds and manually changed configuration files">
		<!-- Create .classpath variant for binary release(#710) -->
		<copy file="${src.userguide.example.manual.dir}/.classpath" tofile="${src.userguide.example.manual.dir}/.classpath-binrelease.generated" overwrite="true"/>
		<copy file="${src.userguide.example.extended.dir}/.classpath" tofile="${src.userguide.example.extended.dir}/.classpath-binrelease.generated" overwrite="true"/>
		<copy file="${src.userguide.example.aspectj.dir}/.classpath" tofile="${src.userguide.example.aspectj.dir}/.classpath-binrelease.generated" overwrite="true"/>
		<copy file="${src.userguide.example.jms.dir}/.classpath" tofile="${src.userguide.example.jms.dir}/.classpath-binrelease.generated" overwrite="true"/>
		<copy file="${src.userguide.example.sigar.dir}/.classpath" tofile="${src.userguide.example.sigar.dir}/.classpath-binrelease.generated" overwrite="true"/>

		<!-- Examples using the plain Jar -->
		<replaceregexp byline="true" flags="g">
			<regexp pattern="&lt;classpathentry .*/Kicker&quot;.*"/>
			<substitution expression="&lt;classpathentry kind=&quot;lib&quot; path=&quot;lib/${dist.kicker.main.jar}&quot;/&gt;"/>
			<fileset dir=".">
				<include name="${src.userguide.example.jms.dir}/.classpath-binrelease.generated"/>
			</fileset>
		</replaceregexp>

		<!-- Examples using the EMF Jar -->
		<replaceregexp byline="true" flags="g">
			<regexp pattern="&lt;classpathentry .*/Kicker&quot;.*"/>
			<substitution expression="&lt;classpathentry kind=&quot;lib&quot; path=&quot;lib/${dist.kicker.main.emf.jar}&quot;/&gt;"/>
			<fileset dir=".">
				<include name="${src.userguide.example.manual.dir}/.classpath-binrelease.generated"/>
				<include name="${src.userguide.example.extended.dir}/.classpath-binrelease.generated"/>
				<include name="${src.userguide.example.sigar.dir}/.classpath-binrelease.generated"/>
			</fileset>
		</replaceregexp>

		<!-- Examples using the AspectJ Jar -->
		<replaceregexp byline="true" flags="g">
			<regexp pattern="&lt;classpathentry .*/Kicker&quot;.*"/>
			<substitution expression="&lt;classpathentry kind=&quot;lib&quot; path=&quot;lib//${dist.kicker.main.aspectj.jar}&quot;/&gt;"/>
			<fileset dir=".">
				<include name="${src.userguide.example.aspectj.dir}/.classpath-binrelease.generated"/>
			</fileset>
		</replaceregexp>

		<!-- Examples referencing libs from /Kicker/lib/ -->
		<replaceregexp byline="true" flags="g">
			<regexp pattern="(&lt;classpathentry .*)/Kicker/lib/(.*&quot;.*)"/>
			<substitution expression="\1lib/\2"/>
			<fileset dir=".">
				<include name="${src.userguide.example.aspectj.dir}/.classpath-binrelease.generated"/>
				<include name="${src.userguide.example.sigar.dir}/.classpath-binrelease.generated"/>
			</fileset>
		</replaceregexp>
	</target>

	<target name="-update-version.examples" depends="-init-version" description="Updates the Kicker version in the examples (e.g., in the .classpath files)">
		<replaceregexp file="${example.javaee.jetty.dir}/start.ini" match="kicker-\S*.jar" replace="${dist.kicker.main.aspectj.jar}" flags="g" />
		<replaceregexp file="${example.javaee.jetty.dir}/start.KickerAspectJActivated.ini" match="kicker-\S*.jar" replace="${dist.kicker.main.aspectj.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.bookstore.dir}/.classpath" match="kicker-\S*.jar" replace="${dist.kicker.main.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.bookstore.dir}/README.txt" match="kicker-\S*.jarr" replace="${dist.kicker.main.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.manual.dir}/.classpath" match="kicker-\S*.jar" replace="${dist.kicker.main.emf.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.manual.dir}/README.txt" match="kicker-\S*.jar" replace="${dist.kicker.main.emf.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.extended.dir}/.classpath" match="kicker-\S*.jar" replace="${dist.kicker.main.emf.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.extended.dir}/README.txt" match="kicker-\S*.jar" replace="${dist.kicker.main.emf.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.aspectj.dir}/build.properties" match="kicker-\S*.jar" replace="${dist.kicker.main.aspectj.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.aspectj.dir}/.classpath" match="kicker-\S*.jar" replace="${dist.kicker.main.aspectj.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.aspectj.dir}/README.txt" match="kicker-\S*.jar" replace="${dist.kicker.main.aspectj.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.jms.dir}/.classpath" match="kicker-\S*.jar" replace="${dist.kicker.main.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.sigar.dir}/.classpath" match="kicker-\S*.jar" replace="${dist.kicker.main.jar}" flags="g" />
	</target>

	<target name="clean" depends="clean-userguide-examples" description="Removes artifacts from previous builds">
		<!-- <delete dir="tmp"/>-->
		<delete dir="${dist.dir}" includeemptydirs="true" />
		<delete dir="${release.dir}" includeemptydirs="true" />
		<delete dir="${maven.dir}" includeemptydirs="true" />
		<delete dir="${build.dir}" includeemptydirs="true" />
	</target>

</project>

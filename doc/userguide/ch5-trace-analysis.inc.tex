%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Trace Analysis and Monitoring
% 
% $Date$
% $Rev$:
% $Author$

\chapter{\KiekerTraceAnalysis{} Tool}\label{chap:aspectJ}

\KiekerTraceAnalysis{} implements the special feature of \Kieker{} allowing to %
monitor, analyze and visualize (distributed) traces of method executions and %
corresponding timing information. For this purpose, it includes monitoring probes employing %
AspectJ~\cite{AspectJ-WebSite}, Java~EE Servlet~\cite{JavaServletTechnology-WebSite}, %
Spring~\cite{Spring-WebSite}, and Apache~CXF~\cite{CXF-WebSite} technology. %
Moreover, it allows to reconstruct and visualize architectural models of the %
monitored systems, e.g., as sequence and dependency diagrams. %

Section~\ref{chap:example} already introduced parts of the monitoring record %
type \class{OperationExecutionRecord}. \KiekerTraceAnalysis{} uses this record %
type to represent monitored executions and associated trace and session information. %
Figure~\ref{fig:OperationExecutionRecordClassDiagramComplete} shows a class diagram %
with all attributes of the record type \class{OperationExecutionRecord}. %
The attributes \method{className}, \method{operationName}, %
\method{tin}, and \method{tout} have been introduced before. %
The attributes \method{traceId} and \method{sessionId} are used to store %
trace and session information; \method{eoi} and \method{ess} contain control-flow %
information needed to reconstruct traces from monitoring data. %
For details on this, we refer to our technical %
report~\cite{vanHoornRohrHasselbringWallerEhlersFreyKieselhorst2009TRContinuousMonitoringOfSoftwareServicesDesignAndApplicationOfTheKiekerFramework}.

\begin{figure}[hb]\centering
\includegraphics[scale=0.8]{images/kieker_OperationExecutionRecord-complete-modified}%
\caption{The class diagram of the operation execution record}
\label{fig:OperationExecutionRecordClassDiagramComplete}
\end{figure}

\noindent Section~\ref{sec:traceMonitoring} describes how to instrument Java %
applications for monitoring trace information. %
It presents the technology-specific probes provided by \Kieker{} for this %
purpose---with a focus on AspectJ. %
Additional technology-specific probes can be implemented based on the existing %
probes. %
Section~\ref{sec:traceAnalysisTool} presents the %
tool which can be used to analyze and visualize the recorded trace %
data.  Examples for the available analysis and visualization outputs %
provided by \KiekerTraceAnalysis{} are presented in %
Section~\ref{sec:traceAnalysisExamples}.

\section{Monitoring Trace Information}\label{sec:traceMonitoring}

The following Sections describe how to use the monitoring probes based on %
AspectJ~(Section~\ref{sec:traceAnalysis:instr:AspectJ}), \ldots.

\subsection{AspectJ-Based Instrumentation}\label{sec:traceAnalysis:instr:AspectJ}

This chapter will show in Section~\ref{sec:aspectJ:annotation} how
to use AspectJ to mark methods to be monitored with a simple annotation
in order to avoid the manual monitoring as seen in Chapter~\ref{chap:example}
and \ref{chap:componentsMonitoring}. Once the methods are marked, the AspectJ-Weaver-Agent
will surround the calls with the necessary code during runtime, similar
to the manually inserted instrumentation code used in Section~\ref{sec:example:monitoring}.
An alternative solution will be shown as well in Section~\ref{sec:aspectJ:fullweaving}, %
where the methods to be instrumented are specified using an external configuration file %
without requiring source code modifications. Both solutions
can be used to reconstruct architectural views and to perform trace
analyses. The result of both will be diagrams similar to Figure~\ref{fig:bookstore:classAndSequenceDiagrams}.

The idea of weaving the monitoring-code into the ``plain'' code
during compile-time seems to suggest itself, but in this chapter it
is only shown how to perform the so called load-time-weaving - the
weaving during runtime, which is more flexible than the compile-time-weaving.

\

\NOTIFYBOX{The Java sources of the AspectJ example presented in %
this section can be found in the %
\file{\aspectJBookstoreApplicationDirDistro{}/} directory of the %
binary release.}

\noindent To weave the code via AspectJ with the \Kieker{},
some new files are required, including the AspectJ-Agent and a configuration
file for AspectJ. Figure~\ref{fig:bookstoreAOP:dirStructure} shows the resulting %
directory tree with the necessary files, based on the Bookstore application from %
Chapter~\ref{chap:example}.

\begin{figure}[H]
\begin{graybox}
\dirtree{%
.1 \DirInDirTree{example/}. %\DTcomment{The root directory of the project}.
.2 \DirInDirTree{build/}\DTcomment{Directory for the Java class files}.
.3 \DirInDirTree{META-INF/}.
.2 \DirInDirTree{META-INF/} \DTcomment{Directory for the configuration files}.
.3 \aopConfigFile. 
.2 \DirInDirTree{lib/} \DTcomment{Directory for the needed libraries}.
.3 \mainJar.
.3 \commonsLoggingJar.
.3 \aspectJWeaverJar.  
.2 \DirInDirTree{src/}\DTcomment{Directory for the source code files}.
.3 \DirInDirTree{bookstoreTracing/}.
.4 Bookstore.java.
.4 BookstoreStarter.java.
.4 Catalog.java.
.4 CRM.java.  
}
\end{graybox}

\caption{The new directory structure of the Bookstore application}
\label{fig:bookstoreAOP:dirStructure}
\end{figure}

\noindent The jar-file \file{aspectjweaver-1.6.9.jar} is included in the %
\dir{lib/} directory of the \Kieker{} binary release. Its %
\dir{META-INF/} directory contains an example \file{\aopConfigFile}.

Once the necessary files have been copied to the example directory,
the source code can be instrumented with the annotation %
\class{OperationExecutionMonitoringProbe}. %
Listing~\ref{lst:BookstoreAspectJ} shows how the annotation is used.

\setJavaCodeListing
\lstinputlisting[caption=Bookstore.java, label=lst:BookstoreAspectJ]{\aspectJBookstoreApplicationDir/src/bookstoreTracing/Bookstore.java}

As a first example, each method of the Bookstore application will be %
annotated. The annotation can be used to instrumented all methods % 
except for constructors. %

The \file{\aopConfigFile} file has to be modified to specify the classes to %
be considered for instrumentation by the AspectJ weaver. %
Listing~\ref{lst:aopConfigFileAnnotations} shows the modified configuration file.

\setXMLListing
\lstinputlisting[caption=aop.xml, label=lst:aopConfigFileAnnotations]{\aspectJBookstoreApplicationDir/META-INF/aop.xml}

\noindent Line~5 tells the AspectJ weaver to consider all classes inside the package %
\class{bookstoreTracing}. Wildcards may be used to specify the classes to include%
---e.g., \lstinline$<include within="bookstoreTracing.Bookstore*"/>$ to weave all %
classes in this package with the prefix \class{Bookstore}. 

Line~9 specifies aspect to be woven into the classes. In this case, the \Kieker{} %
probe \class{OperationExecutionAspectAnnotation} is used which additionally %
requires that method intended to be instrumented are annotated by %
\lstinline[language=Java]{@OperationExecutionMonitoringProbe}.

Listings~\ref{lst:traceAnalysisCompileRunExample1Win} and %
\ref{lst:traceAnalysisCompileRunExample1} show how to compile and run the annotated %
Bookstore application. The \file{\aopConfigFile} must be located in a %
\dir{META-INF/} directory in the classpath---in this case the \dir{build/} directory. %
The AspectJ weaver has to be loaded as a so-called Java-agent. It  %
it is loaded before the \method{main} method and weaves the monitoring aspects into %
the byte code of the Bookstore application.

\setBashListing
\input{ch5-trace-analysis_Compile_Run_Example_1.inc}
\input{ch5-trace-analysis_Compile_Run_Example_1.inc-win}

\noindent After a complete run of the application, the monitoring files should appear in %
the same way as mentioned in Section~\ref{sec:example:monitoring} including the %
additional trace information. 

\paragraph*{Instrumentation without annoations}%\label{sec:aspectJ:fullweaving}

The full monitoring without using any annotations is quite simple. It is only %
necessary to modify the corresponding configuration-file of AspectJ, as can be %
seen in Listing~\ref{lst:aopConfigFileFull}.

\setXMLListing
\lstinputlisting[caption=aop.xml, label=lst:aopConfigFileFull]{ch5-trace-analysis_FullMonitoring-aop.xml}

\noindent The old aspect has been deactivated by removing it (uncommenting it would work as well), while the new aspect \lstinline$<aspect name="kieker.monitoring.probe.aspectJ.executions.OperationExecutionAspectFull"/>$ has been activated. As the name already reveals, the new aspect makes sure that every method within the included classes/packages will be monitored. The exact behavior can be controlled very exactly by using appropriate includes and excludes within the weaver-part of the configuration file. Listing \ref{lst:aopConfigFileFull} shows for example how to make sure that only the methods within the class \class{BookstoreStarter} will be monitored.

The commands to compile and run the source code are just the same as in the Listings~\ref{lst:traceAnalysisCompileRunExample1Win} and \ref{lst:traceAnalysisCompileRunExample1}. The only thing changing is that the annotations within the source code are no longer necessary.

An example log of a complete run can be found in the appendix.

\WARNBOX{By using an own implemented probe it can be necessary to include the corresponding class for this probe as well in the configuration file.}

\subsection{Servlet Filters}\label{sec:traceAnalysis:instr:AspectJ}

The Java Servlet API~\cite{JavaServletTechnology-WebSite} includes the %
\class{javax.servlet.Filter} interface. It can be used to implement %
interceptors for incoming HTTP requests. %
\Kieker{} includes the following two probes %
\class{OperationExecutionRegistrationFilter} and %
\class{OperationExecutionRegistrationAndLoggingFilter} which implement the %
\class{javax.servlet.Filter} interface. %
Both initialize the session and trace information for incoming requests. %
The latter additionally creates an \class{OperationExecutionRecord} for each %
invocation of the filter and passes it to the \class{MonitoringController}.

Listing~\ref{lst:OperationExecutionRegistrationAndLoggingFilterInWebXML} %
demonstrates how to integrate the \class{OperationExecutionRegistrationAndLoggingFilter} %
in a \file{web.xml} file of a web application. 

\setXMLListing
\lstinputlisting[firstline=31,lastline=38,numbers=none,%
caption=\class{OperationExecutionRegistrationAndLoggingFilter} in a \file{web.xml} file,%
label=lst:OperationExecutionRegistrationAndLoggingFilterInWebXML]%
{\JavaEEServletExampleDir/JPetStore-5.0-instrumented/web/WEB-INF/web.xml}

\section{Trace Analysis and Visualization}\label{sec:traceAnalysisTool}

Monitoring data including trace information can be analyzed and visualized with %
the \KiekerTraceAnalysis{} tool which is included in the \Kieker{} binary as well.\\

\WARNBOX{
In order to use this tool, it is necessary to install two other programs:
\begin{enumerate}
\item \textbf{Graphviz} A graph visualization software which can be downloaded from \url{http://www.graphviz.org/}. 
\item \textbf{GNU PlotUtils} A set of tools for generating 2D plot graphics which can be downloaded from \url{http://www.gnu.org/software/plotutils/} (for Linux) and from \url{http://gnuwin32.sourceforge.net/packages/plotutils.htm} (for Windows).
\end{enumerate}
Under Windows it is recommended to add the \dir{bin/} directories of both tools to the ``path'' environment variable.
} \vspace{3mm}

\noindent Once both have been installed, the \KiekerTraceAnalysis{} tool can be %
used. It can be accessed via the wrapper-script \file{trace-analysis.sh} or %
\file{trace-analysis.bat} (Windows) in the \dir{bin/} directory. A %
non-parameterized call of the script prints all possible options on the screen, %
as listed in Appendix~\ref{appendix:wrapperScripts:traceAnalysis}.

Assuming monitoring data, for example the data generated in the previous section, 
within the directory \dir{/tmp/tpmon-20100813-121041532-UTC} (or \dir{C:$\backslash{}$Temp$\backslash{}$tpmon-20100813-121041532-UTC} under Windows) %
should be analyzed by the tool to produce a sequence diagram as well as a call %
tree which should then be written to an existing directory named \dir{out/}. %
The necessary calls are shown in Listing~\ref{lst:traceAnalysis:sequenceDiagram} and \ref{lst:traceAnalysis:sequenceDiagramWin}.

\setBashListing
\input{ch5-trace-analysis_Produce_Sequence_Diagram.inc}
\input{ch5-trace-analysis_Produce_Sequence_Diagram-win.inc}
The result should be similar to the following Figure:
\begin{figure}[H]
\begin{graybox}
\dirtree{%
.1 \DirInDirTree{out/}.
.2 allocationSequenceDiagram-6120391893596504065.pic.
.2 callTree-6120391893596504065.dot.
.2 system-entities.html.
}
\end{graybox}
\end{figure}

\noindent The \file{.pic} and \file{.dot} files can be converted into other formats, %
such as \file{.pdf} , by using \textit{Graphviz} and \textit{PlotUtils}. %
The following Listing~\ref{lst:traceAnalysis:convertDiagrams} demonstrates this. %
The generated diagrams are shown in the following %
Figures~\ref{fig:traceAnalysis:callTree} and~\ref{fig:traceAnalysis:allocSeqDiagr}. 

\input{ch5-trace-analysis_Convert_Diagrams.inc}

\begin{figure}[H]\centering
	\subfigure[]{\label{fig:traceAnalysis:callTree}%
	\includegraphics[height=0.4\textheight]{images/callTree}
	}%
	\subfigure[]{\label{fig:traceAnalysis:allocSeqDiagr}%
	\includegraphics[height=0.4\textheight]{images/allocationSequenceDiagram}
	}%

	\caption{Call Tree~\subref{fig:traceAnalysis:callTree} and Allocation Sequence Diagram~\subref{fig:traceAnalysis:allocSeqDiagr}}
\end{figure}

\NOTIFYBOX{The scripts \file{dotPic-fileConverter.sh} and \file{dotPic-fileConverter.bat} %
convert all \file{.pic} and \file{.dot} in a specified directory. %
See Appendix~\ref{appendix:wrapperScripts:dotPicFileConverter} for details.}

\section{Example \KiekerTraceAnalysis{} Outputs}\label{sec:traceAnalysisExamples}
\input{ch5-trace-analysis-exampleOutputs.inc}
The \Kieker{} download site\footnote{\KiekerDownloadURL{}} includes an additional %
example \file{\JavaEEServletExampleName}. Using the sample Java Web application %
iBATIS JPetStore\footnote{\url{http://ibatis.apache.org/}}, this example %
demonstrates how to employ \KiekerMonitoringPart{} for monitoring a Java application %
running in a Java~EE container---in this case, Apache Tomcat\footnote{\url{http://tomcat.apache.org/}}. %
Monitoring probes based on the Java~EE Servlet API %
and AspectJ are used to monitor execution, trace, and session data (see Section~\ref{chap:aspectJ}).

\

\WARNBOX{The example is currently only prepared for \UnixLikeSystems. However, %
based on the descriptions below, it shouldn't be too difficult to run it under %
Windows}

\section{Preparation of the Tomcat Servlet Container}

\begin{compactenum}
\item Copy the files \file{\mainJar}, \file{\commonsLoggingJar}, and \file{\aspectJWeaverJar} from %
\Kieker{}'s binary distribution to the Tomcat's \dir{lib/} directory.
\item Copy the file \file{\servletWar} from \Kieker{}'s %
binary distribution to the Tomcat's \dir{webapps/} directory.
\item Tomcat's \dir{lib/} directory contains the files \file{kieker.monitoring.properties} %
and \file{aop.xml} --- the configuration of \KiekerMonitoringPart{} and the %
AspectJ-based instrumentation. %
\item Tomcat's \file{bin/catalina.sh} file was modified to add the location %
of the \file{kieker.\-moni\-toring.properties} and the AspectJ agent to the argument %
list of the JVM call:
\end{compactenum}

\setPropertiesListing
\lstinputlisting[firstline=74,firstnumber=74,lastline=75,caption={Excerpt from catalina.sh},numbers=left]{\JavaEEServletExampleDir/Tomcat6.0.18WithJpetStore-withInstrumentedJPetStore/bin/catalina.sh}

\begin{compactenum}\setcounter{enumi}{4}
\item  A prepared \file{jpetstore.war} file is already located in the %
   Tomcat's \dir{webapps/} directory. If you want to rebuild the sources, %
   for example to modify the instrumentation, see Section~\ref{sec:Appendix:JPetStoreExample:rebuild}. 
\end{compactenum}


\section{JPetStore and \KiekerMonitoringPart{} Control Servlet}

\noindent We will now start the Tomcat server and generate some monitoring data by manually %
accessing the JPetStore web application. 

\

\enlargethispage{1.5cm}

\begin{compactenum}
\item Start the Tomcat server using the \file{bin/startup.sh} script in the 
   Tomcat's \dir{bin/} directory (you may have to execute "\texttt{chmod +x bin/*.sh}" %
   in order to set the executable flags of the shell scripts). %
   You should make sure, that the Tomcat started properly, by taking 
   a look at the \file{logs/catalina.out} file. %
   On error, the file \file{logs/localhost.<date>.log} may contain details % 
   to resolve the issue.
\item Now, you can access the JPetStore application by opening the URL
   \url{http://localhost:8080/jpetstore/} (Figure~\ref{fig:jpetstore}). %
   \Kieker{} intialization messages should appear in \file{logs/catalina.out}. %
   The output includes the information where the monitoring data is written to
   (should be Tomcat's \dir{temp/tpmon-<DATE-TIME>/} directory).
\item  Browse through the application to generate some monitoring data. %
   This data can be analyzed and visualized using \KiekerTraceAnalysis{}, %
   as described in Chapter~\ref{chap:aspectJ}.
\item \Kieker{} includes a servlet to control the status of \KiekerMonitoringPart{}. %
   It can be accessed via \url{http://localhost:8080/kieker-monitoring-servlet-\version/} %
   (Figure~\ref{fig:controlServlet}).
\end{compactenum}

\begin{figure}[h]\centering
\hfill
\subfigure[iBATIS JPetStore]{\label{fig:jpetstore}%
\includegraphics[width=0.45\textwidth]{images/jpetstore-example-FFscrsh}}
\hfill
\subfigure[\KiekerMonitoringPart{} control servlet]{\label{fig:controlServlet}%
\includegraphics[width=0.45\textwidth]{images/kieker-servlet-FFscrsh}}
\hfill
\caption{}
\end{figure}

\newpage

\section{Rebuilding the JPetStore Application}\label{sec:Appendix:JPetStoreExample:rebuild}

\noindent In order to rebuild the JPetStore sources (located in \dir{JPetStore-5.0-instrumented/}), 
the following steps are required:

\

\begin{compactenum}
\item Copy the \mainJar{} from \Kieker{}'s
   binary distribution to the JPetStore's \dir{devlib/} directory. %
   \mainJar{} is required for the annotation-based instrumentation %
   (@OperationExecutionMonitoringProbe), as described in Chapter~\ref{chap:aspectJ}
\item Build the JPetStore with the \file{build.xml} by calling \texttt{ant} from %
    within \dir{build/} directory. 
\item You'll find the packaged JPetStore \file{.war}-file in \dir{build/wars/}.
\item Copy the file to the Tomcat's \dir{webapps/} directory.
\end{compactenum}


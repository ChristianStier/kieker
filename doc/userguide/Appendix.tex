%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Appendix
% 
% $Date$
% $Rev$:
% $Author$


\appendix

\chapter*{Appendix}
\addcontentsline{toc}{chapter}{Appendix}
\addtocontents{toc}{\protect\setcounter{tocdepth}{-1}}

\chapter{Wrapper scripts}

The \dir{bin/} directory of the binary release contains some \file{.sh}  and %
\file{.bat} scripts to invoke tools included in the \mainJar{}. %
The following sections give a short description of their functionality and %
list their usage outputs as listed when called without command-line parameters. %

% generated by the script gen-bin-usage-tex.sh with manual adjustments

\section{Script \file{convertLoggingTimestamp.sh|bat}}

\paragraph*{Usage}\

\setTextListing
\lstinputlisting[caption=]{Appendix-usage-convertLoggingTimestamp.sh.inc}

\paragraph*{Example}\

\setTextListing
\begin{lstlisting}
$\lstshellprompt{}$ $\textbf{bin/convertLoggingTimestamp.sh}$ $\textbf{-t}$ 1283156545581511026 1283156546127117246 
1283156545581511026: Mo, 30 Aug 2010 08:22:25 +0000 (UTC) (Mo, 30 Aug 2010 10:22:25 +0200 (local time))
1283156546127117246: Mo, 30 Aug 2010 08:22:26 +0000 (UTC) (Mo, 30 Aug 2010 10:22:26 +0200 (local time))
\end{lstlisting}

\section{Script \file{dotPic-fileConverter.sh|bat}}

\paragraph*{Usage \& Example}\

\setTextListing
\lstinputlisting[caption=,firstline=3]{Appendix-usage-dotPic-fileConverter.sh.inc}

\section{Script \file{logReplay.sh|bat}}

\paragraph*{Usage}\

\setTextListing
\lstinputlisting[caption=]{Appendix-usage-logReplay.sh.inc}

\paragraph*{Example}\

\setTextListing
\begin{lstlisting}
$\lstshellprompt{}$ $\textbf{bin/logReplay.sh}$ $\textbf{--inputdirs}$ $\distributedTestdataDirDistro$ $\textbf{--keep-logging-timestamps}$ $true$ $\textbf{--realtime}$ $true$
\end{lstlisting}

\section{Script \file{trace-analysis.sh|bat}}

\paragraph*{Usage}\

\setTextListing
\lstinputlisting[caption=]{Appendix-usage-trace-analysis.sh.inc}

\paragraph*{Example}\

Examples on using this script can be found in Chapter~\ref{chap:aspectJ} and %
Appendix~\ref{appendix:traceAnalysisOutputExamples}.

\chapter{\KiekerMonitoringPart{} Configuration File}\label{sec:appdx:monitoringproperties}

This is the file \file{\monitoringPropertiesFile} from the binary release and 
constitutes \KiekerMonitoringPart{}'s default configuration.

\

\setXMLListing
\lstinputlisting[caption=\monitoringPropertiesFile]{../../META-INF/kieker.monitoring.properties}

\chapter{Additional Source Code Listings}
\section{MyNamedPipeManager and MyPipe}\label{appendix:pipeListings}
      \setJavaCodeListing
      \lstinputlisting[caption=MyNamedPipeManager.java]{\customComponentsBookstoreApplicationDir/src/bookstoreApplication/MyNamedPipeManager.java}
\newpage
      \setJavaCodeListing
      \lstinputlisting[caption=MyPipe.java]{\customComponentsBookstoreApplicationDir/src/bookstoreApplication/MyPipe.java}

\chapter{Example Console Outputs}

\section{Quick Start Example (Chapter~\ref{chap:example})}\label{sec:appendix:manualInstrumentation:output}
% \subsubsection{Monitoring}
% 		The following listing shows the produced log during a run of the Bookstore Application with the manual monitoring probes.
\input{appendix_ch2_ExampleLog_1.inc}
\newpage
% \subsubsection{Analysis}
% 		The second listing is the log during the analysis of the produced data. It can be seen that some of the calls are accepted and some others refused.
\input{appendix_ch2_ExampleLog_2.inc}
\newpage	
\section{Trace Monitoring, Analysis \& Visualization (Chapter \ref{chap:aspectJ})}
\input{appendix_ch5_ExampleLog_1.inc}
	

\chapter{Ant Scripts}
\section{Quick Start Example (Chapter \ref{chap:example})}
The following \file{build.xml} and \file{build.properties} files can be %
used for compiling and executing the manually instrumentated Bookstore %
application and the analysis, as described in Chapter~\ref{chap:example}. %
The files are included in the directory \file{\manualInstrumentedBookstoreApplicationDirDistro{}/}.

      In order to run the analysis of the application, it is necessary to pass the location of the monitoring log directory. This is done via the parameter \textit{analysis.directory}, e.g.:
      \setBashListing
      \input{appendix_Compile_Run_Example_1.inc}

% \enlargethispage{1.2cm}
      \setXMLListing
      \lstinputlisting[caption=build.properties]{\manualInstrumentedBookstoreApplicationDir/build.properties}
      \lstinputlisting[caption=build.xml]{\manualInstrumentedBookstoreApplicationDir/build.xml}
\newpage
\section{Custom Components (Chapters \ref{chap:componentsMonitoring} and \ref{chap:componentsAnalysis})}
      The following \file{build.xml} and \file{build.properties} files can be used for compiling and executing the manually instrumentated Bookstore application with the custom components, as described in Chapters~\ref{chap:componentsMonitoring} and \ref{chap:componentsAnalysis}. %
The files are included in the directory \file{\customComponentsBookstoreApplicationDirDistro{}/}.
      \setXMLListing
      \lstinputlisting[caption=build.properties]{\customComponentsBookstoreApplicationDir/build.properties}
      \lstinputlisting[caption=build.xml]{\customComponentsBookstoreApplicationDir/build.xml}
\newpage
\section{AspectJ-based Trace Monitoring (Chapter \ref{chap:aspectJ})}
      The following \file{build.xml} and \file{build.properties} files can be used for compiling and executing the Bookstore application instrumentated with AspectJ, as described in Chapter~\ref{chap:aspectJ}. %

The files are included in the directory \file{\aspectJBookstoreApplicationDirDistro{}/}.
      \setXMLListing
      \lstinputlisting[caption=build.properties]{\aspectJBookstoreApplicationDir/build.properties}     
      \lstinputlisting[caption=build.xml]{\aspectJBookstoreApplicationDir/build.xml}

\chapter{Example \KiekerTraceAnalysis{} Outputs}\label{appendix:traceAnalysisOutputExamples}
\input{Appendix-example-TraceAnalysis-outputs.inc}

\chapter{Java~EE Servlet Container Example}

The \Kieker{} download site\footnote{\KiekerDownloadURL{}} includes an additional %
example \file{\JavaEEServletExampleName}. Using the sample Java Web application %
iBATIS JPetStore\footnote{\url{http://ibatis.apache.org/}}, this example %
demonstrates how to employ \KiekerMonitoringPart{} for monitoring a Java application %
running in a Java~EE container. Monitoring probes based on Java~EE and AspectJ %
are used to monitor execution, trace, and session data (see Section~\ref{chap:aspectJ}).

\

\WARNBOX{The example is currently only prepared for \UnixLikeSystems. However, %
based on the descriptions below, it shouldn't be too difficult to run it under %
Windows}

\section{Preparation of the Tomcat Servlet Container}

\begin{compactenum}
\item Copy the files \file{\mainJar}, \file{\commonsLoggingJar}, and \file{\aspectJWeaverJar} from the %
binary distribution to the Tomcat's \dir{lib/} directory.
\item Copy the file \file{\servletWar} from the %
binary distribution to the Tomcat's \dir{webapps/} directory.
\item Tomcat's \dir{lib/} directory contains the files \file{kieker.monitoring.properties} %
and \file{aop.xml} --- the configuration of \KiekerMonitoringPart{} and the %
AspectJ-based instrumentation. %
\item Tomcat's \file{bin/catalina.sh} file was modified to add the location %
of the \file{kieker.\-moni\-toring.properties} and the AspectJ agent to the argument %
list of the JVM call:
\end{compactenum}

\setPropertiesListing
\lstinputlisting[firstline=74,firstnumber=74,lastline=75,caption={Excerpt from catalina.sh},numbers=left]{\JavaEEServletExampleDir/Tomcat6.0.18WithJpetStore-withInstrumentedJPetStore/bin/catalina.sh}

\begin{compactenum}\setcounter{enumi}{4}
\item  A prepared \file{jpetstore.war} file is already located in the %
   Tomcat's \dir{webapps/} directory. If you want to rebuild the sources, %
   for example to modify the instrumentation, see Section~\ref{sec:Appendix:JPetStoreExample:rebuild}. 
\end{compactenum}


\section{JPetStore and \KiekerMonitoringPart{} Control Servlet}

\noindent We will now start the Tomcat server and generate some monitoring data by manually %
accessing the JPetStore web application. 

\

\begin{compactenum}
\item Start the Tomcat server using the \file{bin/startup.sh} script in the 
   Tomcat's \dir{bin/} directory (you may have to "\texttt{chmod +x bin/*.sh}" %
   in order to set the executable flags of the shell scripts). %
   You should make sure, that the Tomcat started properly, by taking 
   a look at the \file{logs/catalina.out} file. %
   On error, the file \file{logs/localhost.<date>.log} may contain details % 
   to resolve the issue.
\item Now, you can access the JPetStore application by opening the URL
   \url{http://localhost:8080/jpetstore/} (Figure~\ref{fig:jpetstore}). %
   Kieker intialization messages should appear in \file{logs/catalina.out}. %
   The output includes the information where the data is written to
   (should be Tomcat's \dir{temp/tpmon-<DATE-TIME>/} directory).
\item  Browse through the application to generate some monitoring data. %
   This data can be analyzed and visualized using \KiekerTraceAnalysis{}, %
   as described in Chapter~\ref{chap:aspectJ}.
\item \Kieker{} includes a control servlet to check the status of \KiekerMonitoringPart{}. %
   It can be accessed via: \url{http://localhost:8080/kieker-monitoring-servlet-\version/} %
   (Figure~\ref{fig:controlServlet}).
\end{compactenum}

\begin{figure}\centering
\hfill
\subfigure[iBATIS JPetStore]{\label{fig:jpetstore}%
\includegraphics[width=0.45\textwidth]{images/jpetstore-example-FFscrsh}}
\hfill
\subfigure[\KiekerMonitoringPart{} control servlet]{\label{fig:controlServlet}%
\includegraphics[width=0.45\textwidth]{images/kieker-servlet-FFscrsh}}
\hfill
\caption{}
\end{figure}

\newpage

\section{Rebuilding the JPetStore Application}\label{sec:Appendix:JPetStoreExample:rebuild}

\noindent In order to rebuild the JPetStore sources (located in \dir{JPetStore-5.0-instrumented/}), 
the following steps are required:

\

\begin{compactenum}
\item Copy the \mainJar{} from \Kieker{}'s
   binary distribution to the JPetStore's \dir{devlib/} directory. %
   \mainJar{} is required for the annotation-based instrumentation %
   (@OperationExecutionMonitoringProbe), as described in Chapter~\ref{chap:aspectJ}
\item build the JPetStore with the \file{build.xml} by calling \texttt{ant} from %
    within \dir{build/} directory. 
\item You'll find the packaged JPetStore \file{.war}-file in \dir{build/wars/}
\item Copy the file to the Tomcat's \dir{webapps/} directory.
\end{compactenum}


\chapter{Using the JMS Writer and Reader}\label{appendix:usingJMS}

This chapter gives a brief description on how to use the \class{AsyncJMSWriter} and \class{JMSReader} %
classes. This example is based on the Bookstore %
application with manual instrumentation presented in Chapter~\ref{chap:example}. %
The directory \dir{\JMSBookstoreApplicationDirDistro/} contains the %
sources, ant scripts etc. 

% \paragraph*{Preparation}

\begin{compactenum}
\item Copy the files \file{\mainJar} and \file{\commonsLoggingJar} from the %
binary distribution to the example's \dir{lib/} directory.
\item The file \file{\JMSBookstoreApplicationDirDistro/META-INF/kieker.monitoring.\-pro\-perties} %
is already configured to use the \class{AsyncJMSWriter}:
\end{compactenum}

\setPropertiesListing
\lstinputlisting[firstline=40,lastline=42,caption=Excerpt from \file{kieker.monitoring.properties} configuring the JMS writer]{\JMSBookstoreApplicationDir/META-INF/kieker.monitoring.properties}

\begin{compactenum}\setcounter{enumi}{2}
\item Download an OpenJMS install archive from \url{http://openjms.sourceforge.net} %
and decompress it to the root directory of the example. 
\item Copy the following files from the OpenJMS \dir{lib/} folder to the \dir{lib/} directory 
   of this example:
\begin{compactenum}
\item \file{openjms-<version>.jar}
\item \file{openjms-common-<version>.jar}
\item \file{openjms-net-<version>.jar}
\item \file{jms-<version>.jar}
\item \file{concurrent-<version>.jar}
\item \file{spice-jndikit-<version>.jar}
\end{compactenum}
\end{compactenum}

\enlargethispage{2cm}

% \paragraph*{Execution}%
 The execution of the example is performed by the following three steps:
\begin{enumerate}
\item Start the JMS server (you may have to set your \class{JAVA\_HOME} variable first):

\setBashListing
\begin{lstlisting}[caption=]
#\lstshellprompt{}# openjms-<version>/bin/startup.sh
\end{lstlisting}
\item Start the analysis part (in a new terminal):
\setBashListing
\begin{lstlisting}[caption=]
#\lstshellprompt{}# ant run-analysis
\end{lstlisting}
\item Start the instrumented Bookstore (in a new terminal):
\setBashListing
\begin{lstlisting}[caption=]
#\lstshellprompt{}# ant run-monitoring
\end{lstlisting}
\end{enumerate}

\chapter{Libraries}
    The following table shows all libraries which are used by \Kieker\ and explains them briefly.
    \input{Libraries}

% \chapter{Troubleshooting}

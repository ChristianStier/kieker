<?xml version="1.0" encoding="UTF-8"?>
<!-- IMPORTANT NOTE: Make sure this file is NOT auto-formatted by the editor -->
<project name="Kieker" default="build-all" basedir="." xmlns:artifact="urn:maven-artifact-ant">
	<property file="build.properties" />

	<property name="TestAspect" value="OperationExecutionAspectFull.java" />

	<target name="-init-version" description="Initializes variables based on the Kieker version number">
		<tstamp />
		<property name="kieker.name" value="Kieker Framework" />
		<property name="kieker.version" value="1.5-SNAPSHOT" />
		<property name="year" value="2011" />
		<property name="copyright" value="the Kieker Project" />
		<property name="dist.kieker.monitoring.servlet.war" value="${kieker.monitoring.servlet.packagenamebase}-${kieker.version}.war" />
		<property name="dist.kieker.main.jar" value="${kieker.main.packagenamebase}-${kieker.version}.jar" />
		<property name="dist.kieker.main.aspectj.jar" value="${kieker.main.packagenamebase}-weaver-${kieker.version}.jar" />

		<property name="kieker.dist.name" value="${kieker.packagenamebase}-${kieker.version}" />
		<property name="dist.kieker.srcBaseName" value="${kieker.dist.name}_${kieker-src.suffix}" />
		<property name="dist.kieker.binBaseName" value="${kieker.dist.name}_${kieker-bin.suffix}" />
		<property name="dist.kieker.apiBaseName" value="${kieker.dist.name}_${kieker-api.suffix}" />
		
		<property name="dist.kieker.userguide.pdf" value="${kieker.dist.name}_${kieker-userguide.suffix}.pdf" />
		<property name="dist.kieker.example.myjmsexample" value="${kieker.dist.name}_${kieker-examples.suffix}-MySimpleKiekerJMSExample" />
		<property name="dist.kieker.example.jpetstoreservlet" value="${kieker.dist.name}_${kieker-examples.suffix}-JavaEEServletContainerExample" />
	</target>

	<target name="-update-version" unless="version.noupdate" depends="-init-version" description="Updates the version number contained in the Kieker sources">
		<replaceregexp file="${src.kieker.common.dir}/kieker/common/util/Version.java" match="VERSION = &quot;.*?&quot;" replace="VERSION = &quot;${kieker.version}-${DSTAMP}&quot;" />
		<replaceregexp match="&lt;version&gt;.*?&lt;/version&gt;" replace="&lt;version&gt;${kieker.version}-${DSTAMP}&lt;/version&gt;">
			<fileset dir=".">
				<include name="pom_ant_kieker*.xml" />
			</fileset>
		</replaceregexp>
	</target>

	<target name="build-all" depends="clean,-init,build-kieker.main,build-kieker.main.aspectj,build-kieker.monitoring-servlet" description="Compiles and packages the Kieker Jar and War files (calls the 'build-kieker-*' targets)">
	</target>

	<target name="-init" depends="-update-version,-init-compile-classpaths" description="Initializes variables and creates directories">
		<!-- Register special aspectJ commands in ant - allow ant to use special AspectJ commands: -->
		<taskdef resource="org/aspectj/tools/ant/taskdefs/aspectjTaskdefs.properties" classpath="${aspectjtoolsjar}" />
		<fail message="Critical error: AspectJ library not found
              in ${aspectjtoolsjar}.
              Check your build.properties.">
			<condition>
				<not>
					<available file="${aspectjtoolsjar}" />
				</not>
			</condition>
		</fail>
		<mkdir dir="${build.dir}" />
		<mkdir dir="${dist.dir}" />
		<mkdir dir="${release.dir}" />
		<mkdir dir="${build.tests.dir}" />
		<mkdir dir="${tmp.dir}" />
	</target>

	<!-- Compile classpaths used for javac and javadoc -->
	<target name="-init-compile-classpaths" description="Initializes the classpath variables for the compile and Javadoc targets">
		<path id="kieker.common-compile-classpath">
			<fileset dir="${lib.dir}">
				<include name="commons-logging-*.jar" />
			</fileset>
		</path>

		<path id="kieker.monitoring-servlet-compile-classpath">
			<fileset dir="${lib.dir}">
				<include name="javax.servlet-*.jar" />
			</fileset>
			<pathelement location="${build.kieker.common.dir}/" />
			<pathelement location="${build.kieker.monitoring.dir}/" />
		</path>

		<path id="kieker.monitoring-compile-classpath">
			<fileset dir="${lib.dir}">
        		<include name="aopalliance-*.jar" />
				<!--<include name="aspectjrt-*.jar" />-->
				<include name="cxf-api-*.jar" />
				<include name="cxf-common-utilities-*.jar" />
				<include name="cxf-rt-core-*.jar" />
				<include name="cxf-rt-bindings-soap-*.jar" />
				<include name="javax.jms-*.jar" />
				<include name="javax.servlet-*.jar" />
				<include name="sigar-*.jar" />
				<include name="springframework.context-*.jar" />
				<include name="springframework.web-*.jar" />
			</fileset>
			<pathelement location="${build.kieker.common.dir}/" />
		</path>

		<path id="kieker.monitoring-ajc-compile-classpath">
			<fileset dir="${lib.dir}">
				<include name="aspectjrt-*.jar" />
				<include name="javax.servlet-*.jar" />
			</fileset>
			<pathelement location="${build.kieker.common.dir}/" />
			<pathelement location="${build.kieker.monitoring.dir}" />
		</path>

		<path id="kieker.analysis-compile-classpath">
			<fileset dir="${lib.dir}">
				<include name="rabbitmq-client.jar" />
				<include name="javax.jms-*.jar" />
				<include name="org.eclipse.*.jar" />
			</fileset>
			<pathelement location="${build.kieker.common.dir}/" />
			<pathelement location="${build.kieker.analysis.model.dir}/" />
		</path>

		<path id="kieker.tools-compile-classpath">
			<fileset dir="${lib.dir}">
				<include name="commons-cli-*.jar" />
			</fileset>
			<pathelement location="${build.kieker.common.dir}/" />
			<pathelement location="${build.kieker.monitoring.dir}/" />
			<pathelement location="${build.kieker.analysis.dir}/" />
		</path>

		<path id="eclipse-external-jars">
			<fileset dir="${lib.dir}">
				<include name="*.jar" />
				<exclude name="aspectjtools-*.jar" />
				<exclude name="aspectjweaver-*.jar" />
				<exclude name="log4j-*.jar" />
			</fileset>
		</path>
	</target>

	<!-- Build kieker.common  -->
	<target name="-compile-kieker.common" depends="-init" description="Compiles the sources commonly used by all Kieker components">
		<delete dir="${build.kieker.common.dir}" />
		<mkdir dir="${build.kieker.common.dir}" />
		<javac destDir="${build.kieker.common.dir}" source="1.6" target="1.6" srcdir="${src.kieker.common.dir}" debug="true" classpathref="kieker.common-compile-classpath" includeAntRuntime="false">
			<compilerarg value="-Xlint:all" /> <!-- ",-path" to suppress path warnings -->
		</javac>
	</target>

	<target name="-compile-kieker.monitoring" depends="-init,-compile-kieker.common" description="Compiles the sources of the Kieker.Monitoring component">
		<delete dir="${build.kieker.monitoring.dir}" />
		<mkdir dir="${build.kieker.monitoring.dir}" />
		<mkdir dir="${build.kieker.monitoring.dir}/META-INF" />
		<javac destDir="${build.kieker.monitoring.dir}" source="1.6" target="1.6" srcdir="${src.kieker.monitoring.dir}" excludes="kieker/monitoring/probe/aspectJ/" debug="true" classpathref="kieker.monitoring-compile-classpath" includeAntRuntime="false">
			<compilerarg value="-Xlint:all" /> <!-- ,-path -->
		</javac>
		<!-- WORKAROUND!!! otherwise the include statement of the aop.xml HAS TO include the apsect.class files -->
		<iajc destdir="${build.kieker.monitoring.dir}" source="1.6" target="1.6" Xlint="ignore" debug="true" classpathref="kieker.monitoring-ajc-compile-classpath">
			<sourceroots>
				<pathelement location="${src.kieker.monitoring.dir}/kieker/monitoring/probe/aspectJ/" />
			</sourceroots>
		</iajc>
		<copy file="${kieker.monitoring.properties.default}" tofile="${build.kieker.monitoring.dir}/META-INF/kieker.monitoring.properties.default" />
		<copy file="${sequence.pic}" tofile="${build.kieker.monitoring.dir}/META-INF/sequence.pic" />
	</target>

	<target name="build-kieker.monitoring-servlet" depends="-init,-compile-kieker.common,-compile-kieker.monitoring" description="Compiles and packages the Kieker.Monitoring Control Servlet War file">
		<delete dir="${build.kieker.monitoring.servlet.dir}" />
		<mkdir dir="${build.kieker.monitoring.servlet.dir}" />
		<javac source="1.6" target="1.6" destDir="${build.kieker.monitoring.servlet.dir}" classpathref="kieker.monitoring-servlet-compile-classpath" srcdir="${src.kieker.monitoring-servlet.dir}" debug="true" includeAntRuntime="false" />
		<war destfile="${dist.dir}/${dist.kieker.monitoring.servlet.war}" webxml="${src.kieker.monitoring-servlet.dir}/kieker/monitoring/servlet/WEB-INF/web.xml">
			<classes dir="${build.kieker.monitoring.servlet.dir}" />
			<zipfileset dir="${src.kieker.monitoring-servlet.dir}/kieker/monitoring/servlet/images" prefix="images" />
			<zipfileset file="LICENSE" prefix="" />
		</war>
	</target>

	<target name="-compile-kieker.analysis.model" depends="-init" description="Compiles the sources of the Analysis Meta-Model">
		<delete dir="${build.kieker.analysis.model.dir}" />
		<mkdir dir="${build.kieker.analysis.model.dir}" />
		<javac destDir="${build.kieker.analysis.model.dir}" source="1.6" target="1.6" srcdir="${src.gen.kieker.analysis.dir}" debug="true" classpathref="kieker.analysis-compile-classpath" includeAntRuntime="false">
			<compilerarg value="-Xlint:all" /> <!-- ,-path -->
		</javac>
	</target>
	
	<target name="-compile-kieker.analysis" depends="-init,-compile-kieker.common,-compile-kieker.analysis.model" description="Compiles the sources of the Kieker.Analysis component">
		<delete dir="${build.kieker.analysis.dir}" />
		<mkdir dir="${build.kieker.analysis.dir}" />
		<javac destDir="${build.kieker.analysis.dir}" source="1.6" target="1.6" srcdir="${src.kieker.analysis.dir}" debug="true" classpathref="kieker.analysis-compile-classpath" includeAntRuntime="false">
			<compilerarg value="-Xlint:all" /> <!-- ,-path -->
		</javac>
	</target>

	<target name="-compile-kieker.tools" depends="-init,-compile-kieker.common,-compile-kieker.monitoring,-compile-kieker.analysis" description="Compiles the sources of Kieker tools">
		<delete dir="${build.kieker.tools.dir}" />
		<mkdir dir="${build.kieker.tools.dir}" />
		<javac destDir="${build.kieker.tools.dir}" source="1.6" target="1.6" srcdir="${src.kieker.tools.dir}" debug="true" classpathref="kieker.tools-compile-classpath" includeAntRuntime="false">
			<compilerarg value="-Xlint:all" /> <!-- ,-path -->
		</javac>
	</target>

	<target name="compile-kieker" depends="-init,-compile-kieker.common,-compile-kieker.monitoring,-compile-kieker.analysis,-compile-kieker.tools" description="Compiles the Kieker sources (calls all 'compile-kieker.*' targets)">
	</target>
	
	<target name="build-kieker.main" depends="-init,compile-kieker" description="Compiles and packages the Kieker Jar file">
		<jar destfile="${dist.dir}/${dist.kieker.main.jar}">
			<fileset dir="${build.kieker.common.dir}" />
			<fileset dir="${build.kieker.analysis.dir}" />
			<fileset dir="${build.kieker.analysis.model.dir}" />
			<fileset dir="${build.kieker.monitoring.dir}" />
			<fileset dir="${build.kieker.tools.dir}" />
			<fileset dir="." includes="LICENSE" />
			<manifest>
				<section name="kieker">
					<attribute name="Specification-Title" value="${kieker.name}"/>
					<attribute name="Specification-Version" value="${kieker.version}"/>
					<attribute name="Specification-Vendor" value="${copyright}"/>
					<attribute name="Implementation-Title" value="${kieker.name}"/>
					<attribute name="Implementation-Version" value="${kieker.version} (${TODAY})"/> 
					<attribute name="Implementation-Vendor" value="${copyright}"/>
				</section>
			</manifest>
		</jar>
	</target>
	
	<target name="build-kieker.main.aspectj" depends="-init,build-kieker.main" description="Compiles and packages the Kieker Jar file including the aspectweaver">
		<jar destfile="${dist.dir}/${dist.kieker.main.aspectj.jar}" filesetmanifest="merge" index="true"> <!--  indexMetaInf="true" flattenAttributes="true" -->
			<zipfileset src="${dist.dir}/${dist.kieker.main.jar}" />
			<zipfileset src="${aspectjweaverjar}" />
			<fileset dir="${lib.dir}" includes="aspectjweaver-*.LICENSE" />
			<manifest>
				<attribute name="Premain-Class" value="org.aspectj.weaver.loadtime.Agent"/>
				<attribute name="Can-Redefine-Classes" value="true"/>
			</manifest>
		</jar>
	</target>
	
	<target name="kieker-src-jar" description="Creates a Jar which contains the KIEKER source code">
		<jar destfile="${tmp.dir}/${src.jar}">
			<fileset dir="${src.kieker.common.dir}" />
			<fileset dir="${src.kieker.analysis.dir}" />
			<fileset dir="${build.kieker.analysis.model.dir}" />
			<fileset dir="${src.kieker.monitoring.dir}" />
			<fileset dir="${src.kieker.tools.dir}" />
			<fileset dir="." includes="LICENSE" />
		</jar>
	</target>

	<target name="dist-kieker-javadoc" depends="-init,-generate-javadoc" description="Packages the Javadoc API documentation archives">
		<tar destfile="${release.dir}/${dist.kieker.apiBaseName}.tar" longfile="gnu">
			<tarfileset dir="${build.api.dir}" prefix="" defaultexcludes="yes" />
		</tar>
		<gzip zipfile="${release.dir}/${dist.kieker.apiBaseName}.tar.gz" src="${release.dir}/${dist.kieker.apiBaseName}.tar" />
		<!-- tar file no longer needed -->
		<delete file="${release.dir}/${dist.kieker.apiBaseName}.tar" />

		<zip zipfile="${release.dir}/${dist.kieker.apiBaseName}.zip">
			<zipfileset dir="${build.api.dir}" prefix="" defaultexcludes="yes" />
		</zip>
	</target>

	<target name="dist-kieker-userguide" depends="-init,-build-userguide" description="Packages the Kieker user guide">
		<copy file="${src.userguide.pdf}" tofile="${release.dir}/${dist.kieker.userguide.pdf}" />
	</target>

	<target name="-generate-javadoc" depends="-init" description="Generate the Javadoc API documentation">
		<delete dir="${build.api.dir}" />
		<mkdir dir="${build.api.dir}" />
		<path id="javadoc-sourcepath">
			<dirset dir=".">
				<include name="${src.kieker.common.dir}" />
				<include name="${src.kieker.analysis.dir}" />
				<include name="${src.kieker.monitoring.dir}" />
				<include name="${src.kieker.monitoring-servlet.dir}" />
				<include name="${src.kieker.tools.dir}" />
			</dirset>
		</path>
		<javadoc sourcepathref="javadoc-sourcepath" destdir="${build.api.dir}" packagenames="kieker.*" access="public" author="true" version="false" use="true" doctitle="Kieker Monitoring and Analysis Framework, Vers. ${kieker.version}&lt;br/&gt;API Documentation" header="Kieker ${kieker.version}" footer="Kieker ${kieker.version}" bottom="Copyright ${year} ${copyright}, &lt;a href=&quot;http://kieker.sourceforge.net&quot;&gt;http://kieker.sourceforge.net&lt;/&gt;">
			<classpath refid="kieker.common-compile-classpath" />
			<classpath refid="kieker.analysis-compile-classpath" />
			<classpath refid="kieker.monitoring-compile-classpath" />
			<classpath refid="kieker.monitoring-ajc-compile-classpath" />
			<classpath refid="kieker.monitoring-servlet-compile-classpath" />
			<classpath refid="kieker.tools-compile-classpath" />
			<link href="http://download.oracle.com/javase/6/docs/api/" />
		</javadoc>
	</target>

	<target name="dist-kieker-sources" depends="-init" description="Packages the source archives (.zip|.tar.gz) for a release">
		<patternset id="dist_src_files-nonbinmode">
			<include name="bin/log4j.properties" />
			<include name="bin/*.bat" />
			<include name="META-INF/*" />
			<!-- a file META-INF/kieker.monitoring.properties will be added during packaging -->
			<include name="src/**/*.java" />
			<include name="src/**/META-INF/*" />
			<include name="${src.gen}/**/*.java" />
			<include name="${src.model.dir}/*.ecore" />
			<include name="test/**/*.java" />
			<include name="test/**/META-INF/*" />
			<include name="${src.kieker.monitoring-servlet.dir}/kieker/monitoring/servlet/WEB-INF/**" />
			<include name="${src.kieker.monitoring-servlet.dir}/kieker/monitoring/servlet/images/**" />
			<include name="lib/**" />
			<!-- The following two files are included under a different name while packaging the archive -->
			<!--<include name="${eclipse-classpath.sample}" />-->
			<!--<include name="${eclipse-project.sample}" />-->
			<include name="build.xml" />
			<include name="build.properties" />
			<include name="HISTORY" />
			<include name="LICENSE" />
			<include name="pom_ant_kieker-*.xml" />
		</patternset>
		<patternset id="dist_src_files-binmode">
			<include name="bin/*.sh" />
		</patternset>

		<tar destfile="${release.dir}/${dist.kieker.srcBaseName}.tar" longfile="gnu">
			<tarfileset file="${eclipse-project.sample}" fullpath="${kieker.dist.name}/.project" />
			<tarfileset file="${eclipse-classpath.sample}" fullpath="${kieker.dist.name}/.classpath" />
			<tarfileset file="${kieker.monitoring.properties.default}" fullpath="${kieker.dist.name}/META-INF/kieker.monitoring.properties" />
			<tarfileset dir="." prefix="${kieker.dist.name}" defaultexcludes="yes">
				<patternset refid="dist_src_files-nonbinmode" />
			</tarfileset>
			<tarfileset dir="." prefix="${kieker.dist.name}" filemode="755" defaultexcludes="yes">
				<patternset refid="dist_src_files-binmode" />
			</tarfileset>
		</tar>
		<gzip zipfile="${release.dir}/${dist.kieker.srcBaseName}.tar.gz" src="${release.dir}/${dist.kieker.srcBaseName}.tar" />
		<!-- tar file no longer needed -->
		<delete file="${release.dir}/${dist.kieker.srcBaseName}.tar" />

		<zip zipfile="${release.dir}/${dist.kieker.srcBaseName}.zip">
			<zipfileset file="${eclipse-project.sample}" fullpath="${kieker.dist.name}/.project" />
			<zipfileset file="${eclipse-classpath.sample}" fullpath="${kieker.dist.name}/.classpath" />
			<zipfileset file="${kieker.monitoring.properties.default}" fullpath="${kieker.dist.name}/META-INF/kieker.monitoring.properties" />
			<zipfileset dir="." prefix="${kieker.dist.name}" defaultexcludes="yes">
				<patternset refid="dist_src_files-nonbinmode" />
			</zipfileset>
			<zipfileset dir="." prefix="${kieker.dist.name}" filemode="755" defaultexcludes="yes">
				<patternset refid="dist_src_files-binmode" />
			</zipfileset>
		</zip>
	</target>

	<target name="dist-kieker-binaries" depends="build-all,-build-userguide,-build-userguide-examples" description="Packages the binary archives (.zip|.tar.gz) for a release">
		<echo message="${src.userguide.pdf}" />

		<patternset id="dist_bin_files-nonbinmode">
			<include name="bin/log4j.properties" />
			<include name="bin/*.bat" />
			<include name="dist/*.jar" />
			<include name="dist/*.war" />
			<include name="META-INF/*" />
			<!-- a file META-INF/kieker.monitoring.properties will added be during packaging the tar.gz|.zip archives below -->
			<include name="lib/*" />
			<include name="lib/sigar-native-libs/*" />
			<exclude name="lib/checkstyle-*/" />	
			<exclude name="lib/findbugs-*/" />			
			<exclude name="lib/maven/" />
			<exclude name="lib/pmd-*/" />
			<exclude name="lib/serenity-*/" />
			<include name="HISTORY" />
			<include name="LICENSE" />
			<include name="${src.userguide.dist.pdf}" />
			<include name="${src.userguide.examples.dir}/README" />
			<include name="${src.userguide.example.bookstore.dir}/build.xml" />
			<include name="${src.userguide.example.bookstore.dir}/build.properties" />
			<include name="${src.userguide.example.bookstore.dir}/.project" />
			<include name="${src.userguide.example.bookstore.dir}/.classpath" />
			<include name="${src.userguide.example.bookstore.dir}/README.txt" />
			<include name="${src.userguide.example.bookstore.dir}/src/**/*.java" />
			<include name="${src.userguide.example.manual.dir}/build.xml" />
			<include name="${src.userguide.example.manual.dir}/build.properties" />
			<include name="${src.userguide.example.manual.dir}/.project" />
			<include name="${src.userguide.example.manual.dir}/.classpath" />
			<include name="${src.userguide.example.manual.dir}/README.txt" />
			<include name="${src.userguide.example.manual.dir}/lib/" />
			<exclude name="${src.userguide.example.manual.dir}/lib/*" />
			<include name="${src.userguide.example.manual.dir}/src/**/*.java" />
			<include name="${src.userguide.example.extended.dir}/build.xml" />
			<include name="${src.userguide.example.extended.dir}/build.properties" />
			<include name="${src.userguide.example.extended.dir}/.project" />
			<include name="${src.userguide.example.extended.dir}/.classpath" />
			<include name="${src.userguide.example.extended.dir}/README.txt" />
			<include name="${src.userguide.example.extended.dir}/lib/" />
			<exclude name="${src.userguide.example.extended.dir}/lib/*" />
			<include name="${src.userguide.example.extended.dir}/src/**/*.java" />
			<include name="${src.userguide.example.extended.dir}/META-INF/kieker.monitoring.properties" />
			<include name="${src.userguide.example.aspectj.dir}/build.xml" />
			<include name="${src.userguide.example.aspectj.dir}/build.properties" />
			<include name="${src.userguide.example.aspectj.dir}/.project" />
			<include name="${src.userguide.example.aspectj.dir}/.classpath" />
			<include name="${src.userguide.example.aspectj.dir}/README.txt" />
			<include name="${src.userguide.example.aspectj.dir}/lib/" />
			<exclude name="${src.userguide.example.aspectj.dir}/lib/*" />
			<include name="${src.userguide.example.aspectj.dir}/testdata/**" />
			<include name="${src.userguide.example.aspectj.dir}/src/**/*.java" />
			<include name="${src.userguide.example.aspectj.dir}/META-INF/aop.xml" />
			<include name="${src.userguide.example.aspectj.dir}/META-INF/kieker.monitoring.properties" />
			<include name="${src.userguide.example.jms.dir}/build.xml" />
			<include name="${src.userguide.example.jms.dir}/build.properties" />
			<include name="${src.userguide.example.jms.dir}/.project" />
			<include name="${src.userguide.example.jms.dir}/.classpath" />
			<include name="${src.userguide.example.jms.dir}/lib/" />
			<exclude name="${src.userguide.example.jms.dir}/lib/*" />
			<include name="${src.userguide.example.jms.dir}/src/**/*.java" />
			<include name="${src.userguide.example.jms.dir}/META-INF/kieker.monitoring.properties-activemq" />
			<include name="${src.userguide.example.jms.dir}/META-INF/kieker.monitoring.properties-hornetq" />
			<include name="${src.userguide.example.jms.dir}/META-INF/kieker.monitoring.properties-openjms" />
			<include name="${src.userguide.example.jms.dir}/META-INF/log4j.properties" />
			<include name="${src.userguide.example.sigar.dir}/build.xml" />
			<include name="${src.userguide.example.sigar.dir}/build.properties" />
			<include name="${src.userguide.example.sigar.dir}/.project" />
			<include name="${src.userguide.example.sigar.dir}/.classpath" />
			<include name="${src.userguide.example.sigar.dir}/lib/" />
			<exclude name="${src.userguide.example.sigar.dir}/lib/*" />
			<include name="${src.userguide.example.sigar.dir}/src/**/*.java" />
			<include name="${src.userguide.example.sigar.dir}/testdata/**" />
			<include name="${example.specjenterprise.dir}/**" />
			<include name="${example.microbenchmark.dir}/**" />
			<exclude name="${example.microbenchmark.dir}/results/**/*" />
			<exclude name="${example.microbenchmark.dir}/tmp/**/*" />
			<exclude name="${example.microbenchmark.dir}/lib/**/*.jar" />
		</patternset>
		<patternset id="dist_bin_files-binmode">
			<include name="bin/*.sh" />
		</patternset>

		<tar destfile="${release.dir}/${dist.kieker.binBaseName}.tar" longfile="gnu">
			<tarfileset file="${kieker.monitoring.properties.default}" fullpath="${kieker.dist.name}/META-INF/kieker.monitoring.properties" />
			<tarfileset file="${src.userguide.pdf}" fullpath="${kieker.dist.name}/doc/${dist.kieker.userguide.pdf}" />
			<!-- Include pre-compiled binaries for the examples -->
			<tarfileset file="${src.userguide.example.extended.dir}/BookstoreApplication.jar" fullpath="${kieker.dist.name}/${src.userguide.example.extended.dir}/BookstoreApplication.jar" />
			<tarfileset file="${src.userguide.example.jms.dir}/BookstoreMonitoring.jar" fullpath="${kieker.dist.name}/${src.userguide.example.jms.dir}/BookstoreMonitoring.jar" />
			<tarfileset file="${src.userguide.example.jms.dir}/BookstoreAnalysis.jar" fullpath="${kieker.dist.name}/${src.userguide.example.jms.dir}/BookstoreAnalysis.jar" />
			<tarfileset file="${src.userguide.example.bookstore.dir}/BookstoreApplication.jar" fullpath="${kieker.dist.name}/${src.userguide.example.bookstore.dir}/BookstoreApplication.jar" />
			<tarfileset file="${src.userguide.example.manual.dir}/BookstoreMonitoring.jar" fullpath="${kieker.dist.name}/${src.userguide.example.manual.dir}/BookstoreMonitoring.jar" />
			<tarfileset file="${src.userguide.example.manual.dir}/BookstoreAnalysis.jar" fullpath="${kieker.dist.name}/${src.userguide.example.manual.dir}/BookstoreAnalysis.jar" />
			<tarfileset file="${src.userguide.example.sigar.dir}/SigarMonitoring.jar" fullpath="${kieker.dist.name}/${src.userguide.example.sigar.dir}/SigarMonitoring.jar" />
			<tarfileset file="${src.userguide.example.sigar.dir}/SigarAnalysis.jar" fullpath="${kieker.dist.name}/${src.userguide.example.sigar.dir}/SigarAnalysis.jar" />
			<tarfileset file="${src.userguide.example.aspectj.dir}/BookstoreApplication.jar" fullpath="${kieker.dist.name}/${src.userguide.example.aspectj.dir}/BookstoreApplication.jar" />
			<tarfileset dir="." prefix="${kieker.dist.name}" defaultexcludes="yes">
				<patternset refid="dist_bin_files-nonbinmode" />
			</tarfileset>
			<tarfileset dir="." prefix="${kieker.dist.name}" filemode="755" defaultexcludes="yes">
				<patternset refid="dist_bin_files-binmode" />
			</tarfileset>
		</tar>
		<gzip zipfile="${release.dir}/${dist.kieker.binBaseName}.tar.gz" src="${release.dir}/${dist.kieker.binBaseName}.tar" />
		<!-- tar file no longer needed -->
		<delete file="${release.dir}/${dist.kieker.binBaseName}.tar" />

		<zip zipfile="${release.dir}/${dist.kieker.binBaseName}.zip">
			<zipfileset file="${kieker.monitoring.properties.default}" fullpath="${kieker.dist.name}/META-INF/kieker.monitoring.properties" />
			<zipfileset file="${src.userguide.pdf}" fullpath="${kieker.dist.name}/doc/${dist.kieker.userguide.pdf}" />
			<zipfileset dir="." prefix="${kieker.dist.name}" defaultexcludes="yes">
				<patternset refid="dist_bin_files-nonbinmode" />
			</zipfileset>
			<!-- Include pre-compiled binaries for the examples -->
			<zipfileset file="${src.userguide.example.extended.dir}/BookstoreApplication.jar" fullpath="${kieker.dist.name}/${src.userguide.example.extended.dir}/BookstoreApplication.jar" />
			<zipfileset file="${src.userguide.example.jms.dir}/BookstoreMonitoring.jar" fullpath="${kieker.dist.name}/${src.userguide.example.jms.dir}/BookstoreMonitoring.jar" />
			<zipfileset file="${src.userguide.example.jms.dir}/BookstoreAnalysis.jar" fullpath="${kieker.dist.name}/${src.userguide.example.jms.dir}/BookstoreAnalysis.jar" />
			<zipfileset file="${src.userguide.example.bookstore.dir}/BookstoreApplication.jar" fullpath="${kieker.dist.name}/${src.userguide.example.bookstore.dir}/BookstoreApplication.jar" />
			<zipfileset file="${src.userguide.example.manual.dir}/BookstoreMonitoring.jar" fullpath="${kieker.dist.name}/${src.userguide.example.manual.dir}/BookstoreMonitoring.jar" />
			<zipfileset file="${src.userguide.example.manual.dir}/BookstoreAnalysis.jar" fullpath="${kieker.dist.name}/${src.userguide.example.manual.dir}/BookstoreAnalysis.jar" />
			<zipfileset file="${src.userguide.example.sigar.dir}/SigarMonitoring.jar" fullpath="${kieker.dist.name}/${src.userguide.example.sigar.dir}/SigarMonitoring.jar" />
			<zipfileset file="${src.userguide.example.sigar.dir}/SigarAnalysis.jar" fullpath="${kieker.dist.name}/${src.userguide.example.sigar.dir}/SigarAnalysis.jar" />
			<zipfileset file="${src.userguide.example.aspectj.dir}/BookstoreApplication.jar" fullpath="${kieker.dist.name}/${src.userguide.example.aspectj.dir}/BookstoreApplication.jar" />
			<zipfileset dir="." prefix="${kieker.dist.name}" filemode="755" defaultexcludes="yes">
				<patternset refid="dist_bin_files-binmode" />
			</zipfileset>
		</zip>
	</target>

	<target name="dist-example-JPetStoreExample" depends="-init" description="Packages the JPetStore example archives (.zip|.tar.gz) for a release">
		<property name="tomcat.dir" value="Tomcat6.0.18WithJpetStore-withInstrumentedJPetStore" />
		<property name="jpetstore.dir" value="JPetStore-5.0-instrumented" />
		<patternset id="dist_jpetstoreExample_files-nonbinmode">
			<include name="${example.jpetstoreservlet.dir}/README" />
			<include name="${example.jpetstoreservlet.dir}/LICENSE" />
			<include name="${example.jpetstoreservlet.dir}/kieker-testdata/**" />
			<include name="${example.jpetstoreservlet.dir}/${tomcat.dir}/**" />
			<exclude name="${example.jpetstoreservlet.dir}/${tomcat.dir}/bin/*.sh" />
			<include name="${example.jpetstoreservlet.dir}/${jpetstore.dir}/**" />
			<exclude name="${example.jpetstoreservlet.dir}/${jpetstore.dir}/devlib/kieker*.jar" />
			<exclude name="${example.jpetstoreservlet.dir}/${jpetstore.dir}/nbproject/**" />
			<exclude name="${example.jpetstoreservlet.dir}/${jpetstore.dir}/build/reports/**" />
			<exclude name="${example.jpetstoreservlet.dir}/${jpetstore.dir}/build/wars/**" />
			<exclude name="${example.jpetstoreservlet.dir}/${jpetstore.dir}/build/webapp/**" />
			<exclude name="${example.jpetstoreservlet.dir}/${jpetstore.dir}/build/work/**" />
			<exclude name="${example.jpetstoreservlet.dir}/${tomcat.dir}/bin/catalina.sh.localjvmmem.conf/" />
			<exclude name="${example.jpetstoreservlet.dir}/${tomcat.dir}/work/**/*" />
			<exclude name="${example.jpetstoreservlet.dir}/${tomcat.dir}/temp/**/*" />
			<exclude name="${example.jpetstoreservlet.dir}/${tomcat.dir}/logs/**/*" />
			<exclude name="${example.jpetstoreservlet.dir}/${tomcat.dir}/webapps/jpetstore/" />
			<exclude name="${example.jpetstoreservlet.dir}/${tomcat.dir}/webapps/kieker*/" />
			<exclude name="${example.jpetstoreservlet.dir}/${tomcat.dir}/lib/kieker*.jar" />
			<exclude name="${example.jpetstoreservlet.dir}/${tomcat.dir}/lib/aspectj*.jar" />
			<exclude name="${example.jpetstoreservlet.dir}/${tomcat.dir}/lib/commons-logging*.jar" />
		</patternset>
		<patternset id="dist_jpetstoreExample_files-binmode">
			<include name="${example.jpetstoreservlet.dir}/${tomcat.dir}/bin/*.sh" />
		</patternset>

		<tar destfile="${release.dir}/${dist.kieker.example.jpetstoreservlet}.tar" longfile="gnu">
			<tarfileset dir="." prefix="${kieker.dist.name}" defaultexcludes="yes">
				<patternset refid="dist_jpetstoreExample_files-nonbinmode" />
			</tarfileset>
			<tarfileset dir="." prefix="${kieker.dist.name}" filemode="755" defaultexcludes="yes">
				<patternset refid="dist_jpetstoreExample_files-binmode" />
			</tarfileset>
		</tar>
		<gzip zipfile="${release.dir}/${dist.kieker.example.jpetstoreservlet}.tar.gz" src="${release.dir}/${dist.kieker.example.jpetstoreservlet}.tar" />
		<!-- tar file no longer needed -->
		<delete file="${release.dir}/${dist.kieker.example.jpetstoreservlet}.tar" />

		<zip zipfile="${release.dir}/${dist.kieker.example.jpetstoreservlet}.zip">
			<zipfileset dir="." prefix="${kieker.dist.name}" defaultexcludes="yes">
				<patternset refid="dist_jpetstoreExample_files-nonbinmode" />
			</zipfileset>
			<zipfileset dir="." prefix="${kieker.dist.name}" filemode="755" defaultexcludes="yes">
				<patternset refid="dist_jpetstoreExample_files-binmode" />
			</zipfileset>
		</zip>
	</target>

	<target name="clean-userguide-examples" description="Removes artifacts from previous builds">
		<ant antfile="build.xml" dir="${src.userguide.example.bookstore.dir}" target="clean"/>
		<ant antfile="build.xml" dir="${src.userguide.example.manual.dir}" target="clean"/>
		<ant antfile="build.xml" dir="${src.userguide.example.extended.dir}" target="clean"/>
		<ant antfile="build.xml" dir="${src.userguide.example.aspectj.dir}" target="clean"/>
		<ant antfile="build.xml" dir="${src.userguide.example.jms.dir}" target="clean"/>
		<ant antfile="build.xml" dir="${src.userguide.example.sigar.dir}" target="clean"/>
	</target>
	
	<target name="-build-userguide-examples" depends="-init,build-all,clean-userguide-examples" description="Builds all userguide examples">
		<path id="classpath">
			<fileset dir="${lib.dir}" includes="**/*.jar" />
			<fileset dir="${dist.dir}" includes="${dist.kieker.main.jar}" />
		</path>
		<!-- src.userguide.example.bookstore.dir -->
		<ant antfile="build.xml" dir="${src.userguide.example.bookstore.dir}">
			<reference refid="classpath" />
			<target name="build-jar" />
		</ant>
		<!-- src.userguide.example.manual.dir -->
		<ant antfile="build.xml" dir="${src.userguide.example.manual.dir}">
			<reference refid="classpath" />
			<target name="-build-jar-analysis" />
		</ant>
		<ant antfile="build.xml" dir="${src.userguide.example.manual.dir}">
			<reference refid="classpath" />
			<target name="-build-jar-monitoring" />
		</ant>
		<!-- src.userguide.example.extended.dir -->
		<ant antfile="build.xml" dir="${src.userguide.example.extended.dir}">
			<reference refid="classpath" />
			<target name="-build-jar" />
		</ant>
		<!-- src.userguide.example.aspectj.dir -->
		<ant antfile="build.xml" dir="${src.userguide.example.aspectj.dir}">
			<reference refid="classpath" />
			<target name="-build-jar" />
		</ant>
		<!-- src.userguide.example.jms.dir -->
		<ant antfile="build.xml" dir="${src.userguide.example.jms.dir}">
			<reference refid="classpath" />
			<target name="-build-jar-analysis" />
		</ant>
		<ant antfile="build.xml" dir="${src.userguide.example.jms.dir}">
			<reference refid="classpath" />
			<target name="-build-jar-monitoring" />
		</ant>
		<!-- src.userguide.example.sigar.dir -->
		<ant antfile="build.xml" dir="${src.userguide.example.sigar.dir}">
			<reference refid="classpath" />
			<target name="-build-jar-analysis" />
		</ant>
		<ant antfile="build.xml" dir="${src.userguide.example.sigar.dir}">
			<reference refid="classpath" />
			<target name="-build-jar-monitoring" />
		</ant>
	</target>

	<target name="-update-version.examples" depends="-init-version" description="Updates the Kieker version in the examples (e.g., in the .classpath files)">
		<replaceregexp file="${src.userguide.example.bookstore.dir}/.classpath" match="kieker-.*.jar" replace="${dist.kieker.main.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.bookstore.dir}/README.txt" match="kieker-.*.jar" replace="${dist.kieker.main.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.manual.dir}/.classpath" match="kieker-.*.jar" replace="${dist.kieker.main.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.manual.dir}/README.txt" match="kieker-.*.jar" replace="${dist.kieker.main.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.extended.dir}/.classpath" match="kieker-.*.jar" replace="${dist.kieker.main.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.extended.dir}/README.txt" match="kieker-.*.jar" replace="${dist.kieker.main.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.aspectj.dir}/build.properties" match="kieker-weaver-.*.jar" replace="${dist.kieker.main.aspectj.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.aspectj.dir}/.classpath" match="kieker-weaver-.*.jar" replace="${dist.kieker.main.aspectj.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.aspectj.dir}/README.txt" match="kieker-weaver-.*.jar" replace="${dist.kieker.main.aspectj.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.jms.dir}/.classpath" match="kieker-.*.jar" replace="${dist.kieker.main.jar}" flags="g" />
		<replaceregexp file="${src.userguide.example.sigar.dir}/.classpath" match="kieker-.*.jar" replace="${dist.kieker.main.jar}" flags="g" />
	</target>
		
	<target name="dist-examples" depends="-update-version.examples,dist-example-JPetStoreExample" description="Packages the example archives (.zip|.tar.gz) for a release">
		
	</target>

	<target name="-build-userguide" description="Creates the Kieker user guide PDF from the LaTeX sources">
		<exec executable="make">
			<arg value="-C" />
			<arg value="${src.userguide.dir}" />
		</exec>
	</target>

	<target name="release" depends="build-all,dist-kieker-sources,dist-kieker-binaries,dist-kieker-javadoc,dist-examples,dist-kieker-userguide" description="Packages the release files (calling all dist- targets)">
		<echo message="Sourceforge release instructions can be found at:" />
		<echo message="https://sourceforge.net/apps/trac/sourceforge/wiki/Release files for download#Createoreditarelease" />
	</target>

	<target name="clean" description="Removes artifacts from previous builds">
		<!-- <delete dir="tmp"/>-->
		<delete dir="${dist.dir}" />
		<delete dir="${release.dir}" />
		<delete dir="${build.dir}" />
	</target>

	<target name="run-test-storage" depends="-compile-tests-monitoring" description="Runs a simple storage test">
		<echo>
            This is a small test for the part of Kieker that
            stores monitoring data. Kieker's monitoring API
            is manually invoked to collect monitoring data.
            Therefore, the instrumentation and logic in the
            monitoring points (the aspects) of Kieker is not
            used.

            The main purpose of this test is to isolate configuration and
            installation problems and to get Kieker running.

            If in kieker.monitoring.properties file system storage (store in database =
            false) is selected, a new file (kieker*.dat) with monitoring data
            should be created in the folder specified in kieker.monitoring.properties
            (default: /tmp).
        </echo>

		<path id="kieker.test-storage-run-classpath">
			<pathelement location="${build.tests.dir}/" />
			<fileset dir="${dist.dir}">
				<include name="${dist.kieker.main.jar}" />
			</fileset>
		</path>

		<java dir="." fork="true" classname="kieker.test.monitoring.manualInstrumentation.storageOnly.StorageOnly" classpathref="kieker.test-storage-run-classpath">
			<jvmarg value="-Dlog4j.configuration=${build.dir}/log4j.properties" />
			<jvmarg value="-Dkieker.monitoring.writer=${tests.writer}" />
			<jvmarg value="-D${tests.writer}.storeInJavaIoTmpdir=${tests.storeInJavaIoTmpdir}" />
			<jvmarg value="-D${tests.writer}.customStoragePath=${tests.storagepath}" />
		</java>
	</target>

	<target name="-compile-tests-common" depends="build-kieker.main" description="Compiles the tests for common classes">
		<path id="common-test-compile-classpath">
			<fileset dir="${lib.dir}">
				<include name="junit-*.jar" />
			</fileset>
			<fileset dir="${dist.dir}">
				<include name="${dist.kieker.main.jar}" />
			</fileset>
		</path>
		<javac source="1.6" target="1.6" destDir="${build.tests.dir}" classpathref="common-test-compile-classpath" srcdir="${test.kieker.common.dir}" includeAntRuntime="false">
		</javac>
	</target>

	<target name="-compile-tests-monitoring" depends="build-kieker.main" description="Compiles the tests for the Kieker.Monitoring component">
		<path id="monitoring-test-compile-classpath">
			<fileset dir="${lib.dir}">
				<include name="junit-*.jar" />
			</fileset>
			<fileset dir="${dist.dir}">
				<include name="${dist.kieker.main.jar}" />
			</fileset>
		</path>
		<javac source="1.6" target="1.6" destDir="${build.tests.dir}" classpathref="monitoring-test-compile-classpath" srcdir="${test.kieker.monitoring.dir}" excludes="kieker/test/monitoring/aspectJ/compileTimeWeaving/" includeAntRuntime="false">
		</javac>
	</target>

	<target name="-compile-tests-analysis" depends="build-kieker.main" description="Compiles the tests for the Kieker.Analysis component">
		<path id="analysis-test-compile-classpath">
			<fileset dir="${lib.dir}">
				<include name="junit-*.jar" />
			</fileset>
			<fileset dir="${dist.dir}">
				<include name="${dist.kieker.main.jar}" />
			</fileset>
		</path>
		<javac source="1.6" target="1.6" destDir="${build.tests.dir}" classpathref="analysis-test-compile-classpath" srcdir="${test.kieker.analysis.dir}" includeAntRuntime="false">
		</javac>
	</target>

	<target name="-compile-tests-tools" depends="build-kieker.main" description="Compiles the tests for the Kieker tools">
		<path id="tools-test-compile-classpath">
			<fileset dir="${lib.dir}">
				<include name="junit-*.jar" />
			</fileset>
			<fileset dir="${dist.dir}">
				<include name="${dist.kieker.main.jar}" />
			</fileset>
		</path>
		<javac source="1.6" target="1.6" destDir="${build.tests.dir}" classpathref="tools-test-compile-classpath" srcdir="${test.kieker.tools.dir}" includeAntRuntime="false">
		</javac>
	</target>

	<target name="run-test-loadTimeWeaving-bookstoreDifferentRecordTypes" depends="-compile-tests-monitoring" description="Runs a load-time weaving test with different record types">
		<path id="kieker.test-loadTimeWeaving-run-classpath">
			<pathelement location="${build.tests.dir}/" />
			<fileset dir="${dist.dir}">
				<include name="${dist.kieker.main.jar}" />
			</fileset>
		</path>

		<copy file="${tests.log4j.properties}" tofile="${build.dir}/log4j.properties" />
		<copy file="${aop.xml.ltwtests.annotation}" tofile="${build.tests.dir}/META-INF/aop.xml" overwrite="true" />
		<java dir="." fork="true" classname="kieker.test.monitoring.aspectJ.loadTimeWeaving.bookstoreDifferentRecordTypes.Bookstore" classpathref="kieker.test-loadTimeWeaving-run-classpath">
			<jvmarg value="-Dkieker.monitoring.writer=${tests.writer}" />
			<jvmarg value="-D${tests.writer}.storeInJavaIoTmpdir=${tests.storeInJavaIoTmpdir}" />
			<jvmarg value="-D${tests.writer}.customStoragePath=${tests.storagepath}" />
			<jvmarg value="-javaagent:${aspectjweaverjar}" />
			<jvmarg value="-Dlog4j.configuration=${build.dir}/log4j.properties" />
			<jvmarg value="-Dorg.aspectj.weaver.showWeaveInfo=true" />
			<!--<jvmarg value="-Dorg.aspectj.weaver.loadtime.configuration=META-INF/aop.xml"/>-->
			<jvmarg value="-Daj.weaving.verbose=true" />
		</java>
	</target>

	<target name="run-test-loadTimeWeaving-bookstoreFullInstrumentation" depends="-compile-tests-monitoring" description="Runs a load-time-weaving tests with full instrumentation">
		<path id="kieker.test-loadTimeWeaving-bookstoreWithoutAnnotation-run-classpath">
			<pathelement location="${build.tests.dir}/" />
			<fileset dir="${dist.dir}">
				<include name="${dist.kieker.main.jar}" />
			</fileset>
		</path>

		<copy file="${tests.log4j.properties}" tofile="${build.dir}/log4j.properties" />
		<copy file="${aop.xml.ltwtests.full}" tofile="${build.tests.dir}/META-INF/aop.xml" overwrite="true" />
		<java dir="." fork="true" classname="kieker.test.monitoring.aspectJ.loadTimeWeaving.bookstoreWithoutAnnotation.BookstoreWA" classpathref="kieker.test-loadTimeWeaving-bookstoreWithoutAnnotation-run-classpath">
			<jvmarg value="-Dkieker.monitoring.writer=${tests.writer}" />
			<jvmarg value="-D${tests.writer}.storeInJavaIoTmpdir=${tests.storeInJavaIoTmpdir}" />
			<jvmarg value="-D${tests.writer}.customStoragePath=${tests.storagepath}" />
			<jvmarg value="-javaagent:${aspectjweaverjar}" />
			<jvmarg value="-Dlog4j.configuration=${build.dir}/log4j.properties" />
			<jvmarg value="-Dorg.aspectj.weaver.showWeaveInfo=true" />
			<jvmarg value="-Daj.weaving.verbose=true" />
		</java>
	</target>

	<target name="run-test-loadTimeWeaving-executionOrderTest" depends="-compile-tests-monitoring" description="Runs a load-time-weaving tests for eoi/ess information">
		<path id="kieker.test-loadTimeWeaving-executionOrderTest-run-classpath">
			<pathelement location="${build.tests.dir}/" />
			<fileset dir="${dist.dir}">
				<include name="${dist.kieker.main.jar}" />
			</fileset>
		</path>

		<copy file="${tests.log4j.properties}" tofile="${build.dir}/log4j.properties" />
		<copy file="${aop.xml.ltwtests.full}" tofile="${build.tests.dir}/META-INF/aop.xml" overwrite="true" />
		<java dir="." fork="true" classname="kieker.test.monitoring.aspectJ.loadTimeWeaving.executionOrderTest.ExecutionOrderTest" classpathref="kieker.test-loadTimeWeaving-executionOrderTest-run-classpath">
			<jvmarg value="-Dkieker.monitoring.writer=${tests.writer}" />
			<jvmarg value="-D${tests.writer}.storeInJavaIoTmpdir=${tests.storeInJavaIoTmpdir}" />
			<jvmarg value="-D${tests.writer}.customStoragePath=${tests.storagepath}" />
			<jvmarg value="-javaagent:${aspectjweaverjar}" />
			<jvmarg value="-Dlog4j.configuration=${build.dir}/log4j.properties" />
			<jvmarg value="-Dorg.aspectj.weaver.showWeaveInfo=true" />
			<jvmarg value="-Daj.weaving.verbose=true" />
		</java>
	</target>

	<target name="-compile-tests-compileTimeWeaving-bookstore" depends="-compile-kieker.monitoring" description="Compiles the sources of the compile-time-weaving tests">
		<path id="kieker.test-compileTimeWeaving-bookstore-compile-classpath">
			<fileset dir="${lib.dir}">
				<include name="aspectjrt-*.jar" />
				<include name="javax.servlet-*.jar" />
			</fileset>
			<pathelement location="${build.tests.dir}/" />
			<fileset dir="${dist.dir}">
				<include name="${dist.kieker.main.jar}" />
			</fileset>
		</path>

		<delete dir="${tmp.dir}/aspects/" />
		<mkdir dir="${tmp.dir}/aspects/" />
		<copy file="${src.kieker.monitoring.dir}/kieker/monitoring/probe/aspectJ/operationExecution/AbstractOperationExecutionAspect.java" todir="${tmp.dir}/aspects/" />
		<copy file="${src.kieker.monitoring.dir}/kieker/monitoring/probe/aspectJ/operationExecution/AbstractOperationExecutionAspectServlet.java" todir="${tmp.dir}/aspects/" />
		<copy file="${src.kieker.monitoring.dir}/kieker/monitoring/probe/aspectJ/operationExecution/${TestAspect}" todir="${tmp.dir}/aspects/" />
		<copy file="${tests.log4j.properties}" tofile="${build.dir}/log4j.properties" />
		<iajc destdir="${build.tests.dir}" source="1.6" target="1.6" verbose="true" classpathref="kieker.test-compileTimeWeaving-bookstore-compile-classpath">
			<sourceroots>
				<pathelement location="${test.kieker.monitoring.dir}/kieker/test/monitoring/aspectJ/compileTimeWeaving/bookstore/" />
				<pathelement location="${tmp.dir}/aspects/" />
			</sourceroots>
		</iajc>
	</target>

	<target name="-compile-tests-compileTimeWeaving-twoConcurrentMethodsExample" depends="-compile-kieker.monitoring" description="Compiles the sources of the compile-time-weaving test with concurrency">
		<path id="kieker.test-compileTimeWeaving-twoConcurrentMethodsExample-compile-classpath">
			<fileset dir="${lib.dir}">
				<include name="aspectjrt-*.jar" />
				<include name="javax.servlet-*.jar" />
			</fileset>
			<pathelement location="${build.tests.dir}/" />
			<fileset dir="${dist.dir}">
				<include name="${dist.kieker.main.jar}" />
			</fileset>
		</path>

		<delete dir="${tmp.dir}/aspects/" />
		<mkdir dir="${tmp.dir}/aspects/" />
		<copy file="${src.kieker.monitoring.dir}/kieker/monitoring/probe/aspectJ/operationExecution/AbstractOperationExecutionAspect.java" todir="${tmp.dir}/aspects/" />
		<copy file="${src.kieker.monitoring.dir}/kieker/monitoring/probe/aspectJ/operationExecution/AbstractOperationExecutionAspectServlet.java" todir="${tmp.dir}/aspects/" />
		<copy file="${src.kieker.monitoring.dir}/kieker/monitoring/probe/aspectJ/operationExecution/${TestAspect}" todir="${tmp.dir}/aspects/" />
		<copy file="${tests.log4j.properties}" tofile="${build.dir}/log4j.properties" />
		<iajc destdir="${build.tests.dir}" source="1.6" target="1.6" verbose="true" classpathref="kieker.test-compileTimeWeaving-twoConcurrentMethodsExample-compile-classpath">
			<sourceroots>
				<pathelement location="${test.kieker.monitoring.dir}/kieker/test/monitoring/aspectJ/compileTimeWeaving/twoConcurrentMethodsExample/" />
				<pathelement location="${tmp.dir}/aspects/" />
			</sourceroots>
		</iajc>
	</target>

	<target name="run-test-compileTimeWeaving-bookstore" depends="-compile-tests-compileTimeWeaving-bookstore" description="Runs a simple compile-time-weaving test">
		<path id="kieker.test-compileTimeWeaving-bookstore-run-classpath">
			<fileset dir="${lib.dir}">
				<include name="aspectjweaver-*.jar" />
			</fileset>
			<pathelement location="${build.tests.dir}/" />
			<fileset dir="${dist.dir}">
				<include name="${dist.kieker.main.jar}" />
			</fileset>
		</path>

		<java dir="." fork="true" classname="kieker.test.monitoring.aspectJ.compileTimeWeaving.bookstore.Bookstore" classpathref="kieker.test-compileTimeWeaving-bookstore-run-classpath">
			<jvmarg value="-Dlog4j.configuration=${build.dir}/log4j.properties" />
			<jvmarg value="-Dkieker.monitoring.writer=${tests.writer}" />
			<jvmarg value="-D${tests.writer}.storeInJavaIoTmpdir=${tests.storeInJavaIoTmpdir}" />
			<jvmarg value="-D${tests.writer}.customStoragePath=${tests.storagepath}" />
		</java>
	</target>

	<target name="run-test-compileTimeWeaving-bookstoreDB" depends="compile-tests,-compile-tests-compileTimeWeaving-bookstore" description="Runs a compile-time-weaving test with an SQL database monitoring log">
		<path id="kieker.test-compileTimeWeaving-bookstoreDB-run-classpath">
			<fileset dir="${lib.dir}">
				<include name="aspectjweaver-*.jar" />
				<include name="derby-*.jar" />
				<include name="mysql-connector-java-*-bin.jar" />
			</fileset>
			<pathelement location="${build.tests.dir}/" />
			<fileset dir="${dist.dir}">
				<include name="${dist.kieker.main.jar}" />
			</fileset>
		</path>

		<delete dir="${tests.javadb.kiekerdb.path}" />
		<!-- delete existing DB -->
		<java dir="." fork="true" classpathref="kieker.test-compileTimeWeaving-bookstoreDB-run-classpath" classname="kieker.test.monitoring.util.JavaDBInitializer">
			<jvmarg value="-Dlog4j.configuration=${build.dir}/log4j.properties" />
		</java>
		<java dir="." fork="true" classname="kieker.test.monitoring.aspectJ.compileTimeWeaving.bookstore.Bookstore" classpathref="kieker.test-compileTimeWeaving-bookstoreDB-run-classpath">
			<jvmarg value="-Dlog4j.configuration=${build.dir}/log4j.properties" />
			<jvmarg value="-Dkieker.monitoring.writer=kieker.monitoring.writer.database.AsyncDbWriter" />
			<jvmarg value="-Dkieker.monitoring.writer.database.AsyncDbWriter.DriverClassname=org.apache.derby.jdbc.EmbeddedDriver" />
			<jvmarg value="-Dkieker.monitoring.writer.database.AsyncDbWriter.ConnectionString=jdbc:derby:tmp/KIEKER;user=DBUSER;password=DBPASS" />
			<jvmarg value="-Dkieker.monitoring.writer.database.AsyncDbWriter.TableName=APP.kiekerdata" />
		</java>
	</target>

	<target name="run-test-compileTimeWeaving-bookstore-synchronized" depends="-compile-tests-compileTimeWeaving-bookstore" description="Runs a compile-time-weaving test with a synchronized method">
		<echo message="Using Bookstore variant with synchronized Catalog.getBooks (is slower)." />

		<path id="kieker.test-compileTimeWeaving-bookstore-synchronized-run-classpath">
			<fileset dir="${lib.dir}">
				<include name="aspectjweaver-*.jar" />
			</fileset>
			<pathelement location="${build.tests.dir}/" />
			<fileset dir="${dist.dir}">
				<include name="${dist.kieker.main.jar}" />
			</fileset>
		</path>

		<java dir="." fork="true" classname="kieker.test.monitoring.aspectJ.compileTimeWeaving.bookstore.synchron.Bookstore" classpathref="kieker.test-compileTimeWeaving-bookstore-synchronized-run-classpath">
			<jvmarg value="-Dlog4j.configuration=${build.dir}/log4j.properties" />
			<jvmarg value="-Dkieker.monitoring.writer=${tests.writer}" />
			<jvmarg value="-D${tests.writer}.storeInJavaIoTmpdir=${tests.storeInJavaIoTmpdir}" />
			<jvmarg value="-D${tests.writer}.customStoragePath=${tests.storagepath}" />
		</java>
	</target>

	<target name="run-test-compileTimeWeaving-twoConcurrentMethodsExample" depends="-compile-tests-compileTimeWeaving-twoConcurrentMethodsExample" description="Runs a compile-time-weaving test with concurrency">
		<path id="kieker.test-compileTimeWeaving-twoConcurrentMethodsExample-run-classpath">
			<fileset dir="${lib.dir}">
				<include name="aspectjweaver-*.jar" />
			</fileset>
			<pathelement location="${build.tests.dir}/" />
			<fileset dir="${dist.dir}">
				<include name="${dist.kieker.main.jar}" />
			</fileset>
		</path>

		<java dir="." fork="true" classname="kieker.test.monitoring.aspectJ.compileTimeWeaving.twoConcurrentMethodsExample.Starter" classpathref="kieker.test-compileTimeWeaving-twoConcurrentMethodsExample-run-classpath">
			<jvmarg value="-Dlog4j.configuration=${build.dir}/log4j.properties" />
			<jvmarg value="-Dkieker.monitoring.writer=${tests.writer}" />
			<jvmarg value="-D${tests.writer}.storeInJavaIoTmpdir=${tests.storeInJavaIoTmpdir}" />
			<jvmarg value="-D${tests.writer}.customStoragePath=${tests.storagepath}" />
		</java>
	</target>

	<taskdef name="junit" classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask" />

	<target name="compile-tests" depends="-compile-tests-common,-compile-tests-analysis,-compile-tests-monitoring,-compile-tests-tools" description="Compile the tests for the Kieker components" />

	<target name="run-tests-integration" 
		depends="run-test-compileTimeWeaving-bookstore, run-test-compileTimeWeaving-bookstore-synchronized, run-test-compileTimeWeaving-bookstoreDB, run-test-compileTimeWeaving-twoConcurrentMethodsExample, run-test-loadTimeWeaving-bookstoreDifferentRecordTypes, run-test-loadTimeWeaving-bookstoreFullInstrumentation, run-test-loadTimeWeaving-executionOrderTest, run-test-storage"
		description="Runs the collection of integration tests (takes quite a while)">
	</target>
	
	<target name="run-tests-junit" depends="compile-tests,kieker-src-jar" description="Runs the JUnit tests">
		<path id="kieker.test-junit-run-classpath">
			<fileset dir="${lib.dir}">
				<include name="junit-*.jar" />
				<include name="org.eclipse.emf.*.jar" />
			</fileset>
			<pathelement location="${build.tests.dir}/" />
			<fileset dir="${dist.dir}">
				<include name="${dist.kieker.main.jar}" />
			</fileset>
		</path>

		<delete dir="${tests.junit-results.dir}" />
		<mkdir dir="${tests.junit-results.dir}" />

		<junit fork="false" printsummary="yes" haltonfailure="no">
			<classpath refid="kieker.test-junit-run-classpath" />

			<formatter type="xml" />
			
			<!-- Serenity system properties. -->
			<sysproperty key="included.packages" value="kieker" />
			<sysproperty key="included.adapters" value="coverage,complexity,dependency" />
			<sysproperty key="included.jars" value="${tmp.dir}/${src.jar}" />

			<!-- Serenity JVM command line. -->
			<jvmarg line="-javaagent:${lib.dir}/serenity-0.4/serenity.jar" />

			<batchtest fork="false" todir="${tests.junit-results.dir}">
				<fileset dir="${build.tests.dir}/">
					<include name="**/junit/**/*Test*.class" />
					<exclude name="**/*$*.class" />
				</fileset>
			</batchtest>
		</junit>

		<antcall target="-test.junit.report" />
	</target>

	<target name="-test.junit.report" depends="" description="Creates the report for the JUnit tests">
		<junitreport todir="${tests.junit-results.dir}">
			<fileset dir="${tests.junit-results.dir}">
				<include name="TEST-*.xml" />
			</fileset>
			<report format="frames" todir="${tests.junit-results.dir}" />
		</junitreport>

		<echo message="To see the test report, open ${tests.junit-results.dir}/index.html in your Web browser." />
	</target>

	<!-- Generates sample files for .classpath and .project Eclipse files -->
	<target name="create-eclipse-sample-files" depends="-init" description="Creates sample Eclipse .project and .classpath files">
		<pathconvert property="eclipse.entries" refid="eclipse-external-jars" dirsep="/" pathsep="&quot;/&gt;&#10;&#09;&#09;&#09;&#09;&lt;classpathentry kind=&quot;lib&quot; path=&quot;">
			<map from="${user.dir}/" to="" />
			<!-- change absolute path back to relative path -->
		</pathconvert>

		<!-- Make sure that the following echo message (the content of the template file) is 
		NOT auto-formatted by the editor. Particularly, there must NOT be a leading empty line. -->
		<echo file="${eclipse-classpath.sample}"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
			<!-- Sample eclipse .classpath file. Copy this file to ".classpath". -->
			<classpath>
				<classpathentry kind="src" path="${src.kieker.common.dir}"/>
				<classpathentry kind="src" path="${src.kieker.analysis.dir}"/>
				<classpathentry kind="src" path="${src.kieker.monitoring.dir}"/>
				<classpathentry kind="src" path="${src.kieker.monitoring-servlet.dir}"/>
				<classpathentry kind="src" path="${src.kieker.tools.dir}"/>
				<classpathentry kind="src" path="${test.kieker.common.dir}"/>
				<classpathentry kind="src" path="${test.kieker.analysis.dir}"/>
				<classpathentry kind="src" path="${test.kieker.monitoring.dir}"/>
				<classpathentry kind="src" path="${test.kieker.tools.dir}"/>
				<classpathentry kind="con" path="org.eclipse.pde.core.requiredPlugins"/>
				<classpathentry kind="src" path="${src.gen.kieker.analysis.dir}"/>
				<classpathentry kind="con" path="org.eclipse.jdt.launching.JRE_CONTAINER/org.eclipse.jdt.internal.debug.ui.launcher.StandardVMType/JavaSE-1.6"/>
				<classpathentry kind="lib" path="${eclipse.entries}"/>
				<classpathentry kind="output" path="build-eclipse"/>
			</classpath>
        ]]>
        </echo>
		<!-- Make sure that the following echo message (the content of the template file) is 
		NOT auto-formatted by the editor. Particularly, there must NOT be a leading empty line. -->
		<echo file="${eclipse-project.sample}"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
			<!-- Sample eclipse .project file. Copy this file to ".project". -->
			<projectDescription>
				<name>Kieker ${kieker.version}</name>
				<comment>
				</comment>
				<projects>
				</projects>
				<buildSpec>
					<buildCommand>
						<name>org.eclipse.jdt.core.javabuilder</name>
						<arguments>
						</arguments>
					</buildCommand>
				</buildSpec>
				<natures>
					<nature>org.eclipse.jdt.core.javanature</nature>
				</natures>
			</projectDescription>
        ]]>
        </echo>
	</target>

	<target name="-mvn-init" depends="-update-version">
		<xmlproperty file="pom.xml" prefix="pom.xml" />
		<path id="maven-ant-tasks.classpath" path="lib/maven/maven-ant-tasks-2.1.0.jar" />
		<typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="urn:maven-artifact-ant" classpathref="maven-ant-tasks.classpath" />
	</target>

	<target name="mvn-deploy" depends="-mvn-init, -mvn-deploy-base, -mvn-deploy-jar, -mvn-deploy-war" />

	<target name="-mvn-deploy-jar" depends="-compile-kieker.monitoring, -mvn-deploy-base">
		<artifact:install-provider artifactId="wagon-ssh" version="1.0-beta-2" />
		<artifact:pom id="mavenproject" file="pom_ant_kieker-jar.xml" />
		<artifact:deploy file="${dist.dir}/${dist.kieker.main.jar}">
			<pom refid="mavenproject" />
		</artifact:deploy>
	</target>

	<target name="-mvn-deploy-war" depends="build-kieker.monitoring-servlet, -mvn-deploy-jar">
		<artifact:install-provider artifactId="wagon-ssh" version="1.0-beta-2" />
		<artifact:pom id="mavenproject" file="pom_ant_kieker-war.xml" />
		<artifact:deploy file="${dist.dir}/${dist.kieker.monitoring.servlet.war}">
			<pom refid="mavenproject" />
		</artifact:deploy>
	</target>

	<target name="-mvn-deploy-base" depends="-mvn-init">
		<artifact:install-provider artifactId="wagon-ssh" version="1.0-beta-2" />
		<artifact:pom id="mavenproject" file="pom_ant_kieker-base.xml" />
		<artifact:deploy file="pom_ant_kieker-base.xml">
			<pom refid="mavenproject" />
		</artifact:deploy>
	</target>

	<!-- http://samoa.informatik.uni-kiel.de/kieker/trac/ticket/292: add run-tests-integration BEFORE static-analysis -->
	<target name="run-hudson-kieker" depends="build-all,run-tests-junit,static-analysis"
	        description="Ant target used by the Hudson build (includes run-tests-junit,run-tests-integration,static-analysis)"/>
	
	<target name="static-analysis" depends="findbugs, pmd, checkstyle" description="Performs static analysis of Kieker's source and binary code employing FindBugs and PMD" />
	
  <target name="findbugs" depends="build-all,compile-tests" description="Performs a byte code analysis to find potential bugs employing findbugs">
    <taskdef name="findbugs" classname="edu.umd.cs.findbugs.anttask.FindBugsTask" classpath="${lib.dir}/findbugs-1.3.9/lib/findbugs-ant.jar"/>
		<findbugs home="${lib.dir}/findbugs-1.3.9"
				reportLevel="low"
				effort="max"
				excludeFilter="${lib.dir}/findbugs-1.3.9/fb-filter.xml"
				output="xml"
				outputFile="${tmp.dir}/kieker-fb.xml" >
			<auxClasspath>
				<fileset dir="${lib.dir}" includes="*.jar"/>
				<fileset dir="${lib.dir}/findbugs-1.3.9/auxlib" includes="*.jar"/>
			</auxClasspath>
			<sourcePath path="${src.dir}" />
			<sourcePath path="${test.dir}" />
			<class location="${build.dir}" />
		</findbugs>
	</target>

	<target name="pmd" description="Performs a source code analysis employing PMD">
    <path id="pmd.libs">
      <fileset dir="${lib.dir}/pmd-4.3/lib">
        <include name="*.jar" />
      </fileset>
    </path>
		<taskdef name="pmd" classname="net.sourceforge.pmd.ant.PMDTask" classpathref="pmd.libs"/>
		<pmd shortFilenames="true" rulesetfiles="${lib.dir}/pmd-4.3/pmdrules.xml" targetjdk="1.6" >
			<formatter type="xml" toFile="${tmp.dir}/pmd_report.xml" />
			<fileset dir="${src.dir}" includes="**/*.java" />
			<fileset dir="${test.dir}" includes="**/*.java" />
		</pmd>
		<echo message="PMD report written to '${tmp.dir}/pmd_report.xml'" />
	</target>
	
	<target name="checkstyle" depends="build-all,compile-tests" description="Uses Checkstyle to find potential problems">
    <taskdef resource="checkstyletask.properties" classpath="${lib.dir}/checkstyle-5.5/lib/checkstyle-5.5-all.jar"/>
		<checkstyle config="${lib.dir}/checkstyle-5.5/cs-conf.xml" failOnViolation="false">
      <classpath>
      	<fileset dir="${lib.dir}">
          <include name="*.jar" />
        </fileset>
        <fileset dir="${dist.dir}">
          <include name="${dist.kieker.main.jar}" />
        </fileset>
			</classpath>
			<fileset dir="${src.dir}" includes="**/*.java"/>
			<fileset dir="${test.dir}" includes="**/*.java"/>
			<formatter type="xml" toFile="${tmp.dir}/cs_report.xml"/>
		</checkstyle>
		<echo message="Checkstyle report written to '${tmp.dir}/cs_report.xml'" />
	</target>
</project>
